<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>FormBlast â€” å–¶æ¥­ãƒ•ã‚©ãƒ¼ãƒ è‡ªå‹•é€ä¿¡</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0a0a0f;--surface:#12121a;--surface2:#1a1a26;--border:rgba(255,255,255,0.07);--accent:#4f7cff;--accent2:#a259ff;--success:#22d3a0;--warning:#f5a623;--danger:#ff4f6e;--text:#e8e8f0;--muted:#6b6b85}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:'Noto Sans JP',sans-serif;min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;top:-30%;left:-10%;width:60%;height:60%;background:radial-gradient(ellipse,rgba(79,124,255,0.08) 0%,transparent 70%);pointer-events:none;z-index:0}
header{position:sticky;top:0;z-index:100;backdrop-filter:blur(20px);background:rgba(10,10,15,0.85);border-bottom:1px solid var(--border);padding:14px 20px;display:flex;align-items:center;justify-content:space-between}
.logo{font-family:'Syne',sans-serif;font-weight:800;font-size:1.3rem;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.sdot{width:8px;height:8px;border-radius:50%;background:var(--muted);display:inline-block;margin-right:6px;transition:all .3s}
.sdot.on{background:var(--success);box-shadow:0 0 6px var(--success)}
.container{position:relative;z-index:1;max-width:900px;margin:0 auto;padding:24px 16px 60px}
.steps{display:flex;gap:4px;margin-bottom:28px;background:var(--surface);border-radius:14px;padding:6px;border:1px solid var(--border)}
.sbtn{flex:1;padding:10px 6px;border:none;background:transparent;color:var(--muted);font-family:'Noto Sans JP',sans-serif;font-size:0.72rem;font-weight:500;border-radius:10px;cursor:pointer;transition:all .25s;white-space:nowrap}
.sbtn.active{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;font-weight:700;box-shadow:0 2px 12px rgba(79,124,255,0.3)}
.sbtn.done{color:var(--success)}
.card{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:24px;margin-bottom:16px}
.card:hover{border-color:rgba(79,124,255,0.2)}
.ctitle{font-family:'Syne',sans-serif;font-size:1rem;font-weight:700;margin-bottom:18px;display:flex;align-items:center;gap:10px}
.badge{display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:8px;font-size:.75rem;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;flex-shrink:0}
.fg{margin-bottom:14px}
label{display:block;font-size:.78rem;color:var(--muted);margin-bottom:6px;font-weight:500}
input[type=text],input[type=email],input[type=tel],input[type=url],textarea,select{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:12px 14px;color:var(--text);font-family:'Noto Sans JP',sans-serif;font-size:.92rem;outline:none;transition:border-color .2s;-webkit-appearance:none}
input:focus,textarea:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(79,124,255,0.1)}
textarea{resize:vertical;min-height:120px;line-height:1.6}
select option{background:var(--surface2);color:var(--text)}
.company-list{display:flex;flex-direction:column;gap:12px}
.ccard{background:var(--surface2);border:1px solid var(--border);border-radius:16px;padding:16px}
.ccard-h{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.cnum{width:28px;height:28px;border-radius:8px;background:var(--surface);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-size:.8rem;font-weight:700;color:var(--muted);flex-shrink:0}
.cname{font-weight:600;font-size:.9rem;flex:1}
.rbtn{background:none;border:none;color:var(--muted);cursor:pointer;font-size:1.1rem;padding:4px;border-radius:6px;transition:color .2s}
.rbtn:hover{color:var(--danger)}
.cfields{display:flex;flex-direction:column;gap:10px}
.ai-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;background:rgba(79,124,255,0.1);border:1px solid rgba(79,124,255,0.2);border-radius:20px;font-size:.72rem;color:var(--accent);font-weight:600;margin-top:8px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:14px 24px;border:none;border-radius:12px;font-family:'Noto Sans JP',sans-serif;font-weight:700;font-size:.92rem;cursor:pointer;transition:all .2s;-webkit-tap-highlight-color:transparent}
.btn-p{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;box-shadow:0 4px 20px rgba(79,124,255,0.3)}
.btn-p:hover{transform:translateY(-1px)}
.btn-s{background:var(--surface2);border:1px solid var(--border);color:var(--text)}
.btn-s:hover{border-color:var(--accent)}
.btn-ok{background:linear-gradient(135deg,var(--success),#0ea676);color:#fff;box-shadow:0 4px 20px rgba(34,211,160,0.25)}
.btn-d{background:linear-gradient(135deg,var(--danger),#c9304c);color:#fff}
.btn-sm{padding:8px 14px;font-size:.82rem}
.btn-bl{width:100%}
.btn:disabled{opacity:.4;cursor:not-allowed;transform:none!important}
.add-btn{width:100%;padding:14px;background:transparent;border:1.5px dashed rgba(79,124,255,0.3);border-radius:16px;color:var(--accent);font-family:'Noto Sans JP',sans-serif;font-size:.88rem;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;margin-top:12px}
.add-btn:hover{background:rgba(79,124,255,0.05);border-color:var(--accent)}
.abar{display:flex;gap:10px;margin-top:20px}
.abar .btn{flex:1}
.tcard{background:var(--surface2);border:1.5px solid var(--border);border-radius:14px;padding:14px 16px;cursor:pointer;transition:all .2s;position:relative;margin-bottom:10px}
.tcard:hover{border-color:rgba(79,124,255,0.3);transform:translateX(3px)}
.tcard.sel{border-color:var(--accent);background:rgba(79,124,255,0.06)}
.tcard.sel::before{content:'âœ“';position:absolute;right:14px;top:50%;transform:translateY(-50%);color:var(--accent);font-weight:700}
.tcard.auto-sel{border-color:var(--success);background:rgba(34,211,160,0.06)}
.tcard.auto-sel::before{content:'ğŸ¤–';position:absolute;right:14px;top:50%;transform:translateY(-50%)}
.ttitle{font-weight:700;font-size:.88rem;margin-bottom:4px}
.tprev{font-size:.77rem;color:var(--muted);line-height:1.5;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
.edit-area{margin-top:18px}
.preview-item{background:var(--surface2);border:1px solid var(--border);border-radius:16px;overflow:hidden;margin-bottom:16px}
.pitem-h{padding:14px 16px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border)}
.pname{font-weight:700;font-size:.9rem;flex:1}
.sbadge{font-size:.72rem;font-weight:700;padding:4px 10px;border-radius:20px}
.sbadge.ready{background:rgba(34,211,160,0.15);color:var(--success)}
.sbadge.error{background:rgba(255,79,110,0.15);color:var(--danger)}
.sbadge.submitted{background:rgba(34,211,160,0.2);color:var(--success)}
.pdetail{padding:12px 16px;font-size:.8rem;color:var(--muted)}
.ftag{padding:3px 9px;border-radius:6px;font-size:.72rem;font-weight:600;display:inline-block;margin:2px}
.ftag.ok{background:rgba(34,211,160,0.12);color:var(--success)}
.ftag.ng{background:rgba(255,79,110,0.12);color:var(--danger)}
.loading-overlay{display:none;position:fixed;inset:0;z-index:999;background:rgba(10,10,15,0.85);backdrop-filter:blur(8px);align-items:center;justify-content:center;flex-direction:column;gap:20px}
.loading-overlay.active{display:flex}
.spinner{width:48px;height:48px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.ltext{font-family:'Syne',sans-serif;font-size:1.1rem;font-weight:700}
.lsub{font-size:.82rem;color:var(--muted);text-align:center;max-width:260px}
.toast-c{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);z-index:1000;display:flex;flex-direction:column;gap:10px;align-items:center;width:90%;max-width:400px}
.toast{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:12px 18px;font-size:.85rem;font-weight:600;box-shadow:0 8px 32px rgba(0,0,0,0.4);animation:slideUp .3s ease;width:100%;text-align:center}
.toast.success{border-color:var(--success);color:var(--success)}
.toast.error{border-color:var(--danger);color:var(--danger)}
.toast.info{border-color:var(--accent);color:var(--accent)}
@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.modal{display:none;position:fixed;inset:0;z-index:998;background:rgba(10,10,15,0.9);backdrop-filter:blur(10px);align-items:flex-end;justify-content:center;padding:20px}
.modal.active{display:flex}
.mbox{background:var(--surface);border:1px solid var(--border);border-radius:24px 24px 0 0;padding:28px 24px;width:100%;max-width:480px;animation:slideUp .3s ease}
.mtitle{font-family:'Syne',sans-serif;font-size:1.2rem;font-weight:800;margin-bottom:12px}
.mbody{font-size:.88rem;color:var(--muted);line-height:1.6;margin-bottom:24px}
.mactions{display:flex;gap:10px}
.section{display:none}
.section.active{display:block}
.result-summary{text-align:center;padding:40px 20px}
.result-icon{font-size:3.5rem;margin-bottom:16px}
.result-title{font-family:'Syne',sans-serif;font-size:1.5rem;font-weight:800;margin-bottom:8px}
.result-sub{color:var(--muted);font-size:.88rem}
.sent-badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;background:rgba(34,211,160,0.12);border:1px solid rgba(34,211,160,0.25);border-radius:20px;font-size:.7rem;font-weight:700;color:var(--success)}
.unsent-badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;background:rgba(107,107,133,0.1);border:1px solid var(--border);border-radius:20px;font-size:.7rem;font-weight:700;color:var(--muted)}
.ccard.sent{border-color:rgba(34,211,160,0.2);background:rgba(34,211,160,0.03)}
.del-bar{display:flex;align-items:center;gap:10px;padding:10px 0;margin-bottom:8px;border-bottom:1px solid var(--border)}
.chk{width:18px;height:18px;accent-color:var(--accent);cursor:pointer;flex-shrink:0}
.del-btn-mini{padding:6px 14px;background:rgba(255,79,110,0.1);border:1px solid rgba(255,79,110,0.3);border-radius:8px;color:var(--danger);font-size:.78rem;font-weight:700;cursor:pointer;font-family:'Noto Sans JP',sans-serif}
.del-btn-mini:hover{background:rgba(255,79,110,0.2)}
.saved-indicator{font-size:.7rem;color:var(--success);display:none;margin-left:8px}
.saved-indicator.show{display:inline}
.pattern-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
.pattern-chip{padding:6px 14px;border-radius:20px;font-size:.78rem;font-weight:700;cursor:pointer;border:1.5px solid var(--border);background:var(--surface2);color:var(--muted);transition:all .2s}
.pattern-chip.sel{border-color:var(--accent);background:rgba(79,124,255,0.1);color:var(--accent)}
.pattern-chip.auto{border-color:var(--success);background:rgba(34,211,160,0.1);color:var(--success)}
.divider{border:none;border-top:1px solid var(--border);margin:16px 0}
@media(min-width:600px){.cfields{display:grid;grid-template-columns:1fr 1fr}.modal{align-items:center}.mbox{border-radius:24px}.container{padding:32px 24px 80px}}
</style>
</head>
<body>
<header>
  <div class="logo">âš¡ FormBlast</div>
  <div style="display:flex;align-items:center;font-size:.78rem;color:var(--muted)">
    <span class="sdot" id="sdot"></span><span id="stxt">æœªæ¥ç¶š</span>
  </div>
</header>
<div class="container">
  <div class="steps">
    <button class="sbtn active" onclick="goStep(1)" id="sb1">â‘  é€ä¿¡è€…æƒ…å ±</button>
    <button class="sbtn" onclick="goStep(2)" id="sb2">â‘¡ ä¼æ¥­è¨­å®š</button>
    <button class="sbtn" onclick="goStep(3)" id="sb3">â‘¢ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</button>
    <button class="sbtn" onclick="goStep(4)" id="sb4">â‘£ ç¢ºèªãƒ»é€ä¿¡</button>
  </div>

  <!-- STEP1 -->
  <div class="section active" id="step1">
    <div class="card">
      <div class="ctitle"><span class="badge">1</span>ã‚ãªãŸã®æƒ…å ±</div>
      <div style="display:flex;align-items:center;margin-bottom:12px">
        <span style="font-size:.75rem;color:var(--muted)">å…¥åŠ›å†…å®¹ã¯è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™</span>
        <span class="saved-indicator" id="senderSaved">âœ“ ä¿å­˜ã—ã¾ã—ãŸ</span>
      </div>
      <div class="fg"><label>ãŠåå‰ *</label><input type="text" id="sName" placeholder="å±±ç”° å¤ªéƒ"/></div>
      <div class="fg"><label>ä¼šç¤¾å *</label><input type="text" id="sCompany" placeholder="æ ªå¼ä¼šç¤¾ãƒªãƒ­ã‚¯ãƒ©ãƒ–"/></div>
      <div class="fg"><label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ *</label><input type="email" id="sEmail" placeholder="yamada@example.com"/></div>
      <div class="fg"><label>é›»è©±ç•ªå·</label><input type="tel" id="sPhone" placeholder="03-1234-5678"/></div>
    </div>
    <div class="abar"><button class="btn btn-p btn-bl" onclick="nextStep(1)">æ¬¡ã¸ã€€â†’</button></div>
  </div>

  <!-- STEP2 -->
  <div class="section" id="step2">
    <div class="card">
      <div class="ctitle">
        <span class="badge">2</span>é€ä¿¡å…ˆä¼æ¥­ï¼ˆæœ€å¤§10ç¤¾ï¼‰
        <span class="saved-indicator" id="companiesSaved">âœ“ ä¿å­˜ã—ã¾ã—ãŸ</span>
      </div>
      <div class="company-list" id="companyList"></div>
      <button class="add-btn" id="addBtn" onclick="addCompany()"><span>ï¼‹</span> ä¼æ¥­ã‚’è¿½åŠ ã™ã‚‹</button>
    </div>
    <div class="abar">
      <button class="btn btn-s" onclick="goStep(1)">â† æˆ»ã‚‹</button>
      <button class="btn btn-p" onclick="nextStep(2)">æ¬¡ã¸ã€€â†’</button>
    </div>
  </div>

  <!-- STEP3 -->
  <div class="section" id="step3">
    <div class="card">
      <div class="ctitle"><span class="badge">3</span>é€ä¿¡å†…å®¹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</div>

      <!-- é€ä¿¡ãƒ‘ã‚¿ãƒ¼ãƒ³é¸æŠ -->
      <div class="fg">
        <label>ğŸ“‹ é€ä¿¡ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆæ¥­æ…‹åˆ¥ï¼‰</label>
        <div class="pattern-row" id="patternRow"></div>
        <div id="aiHint" style="font-size:.75rem;color:var(--success);margin-top:4px;display:none">ğŸ¤– ä¼æ¥­ã‚µã‚¤ãƒˆã‹ã‚‰æ¥­æ…‹ã‚’è‡ªå‹•åˆ¤å®šã—ã¾ã—ãŸ</div>
      </div>

      <hr class="divider">

      <!-- ä¼šç¤¾æ¦‚è¦é¸æŠ -->
      <div class="fg">
        <label>ğŸ¢ ä¼šç¤¾æ¦‚è¦ãƒ‘ã‚¿ãƒ¼ãƒ³</label>
        <select id="companyDescSel" onchange="updatePreview()">
          <option value="0">â‘¤ é£²é£Ÿåº—å‘ã‘é€å®¢ç‰¹åŒ–ç‰ˆï¼ˆæ¨å¥¨ï¼‰</option>
          <option value="1">â‘  è¶…ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆ</option>
          <option value="2">â‘¡ æ¨©å¨æ€§å¼·èª¿ç‰ˆï¼ˆä¸Šå ´ã‚°ãƒ«ãƒ¼ãƒ—è¨´æ±‚ï¼‰</option>
          <option value="3">â‘¢ å®Ÿç¸¾å¼·èª¿ç‰ˆï¼ˆæ•°å­—ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆé‡è¦–ï¼‰</option>
          <option value="4">â‘£ ä¿¡é ¼ãƒ»å®‰å®šæ„Ÿé‡è¦–ç‰ˆ</option>
          <option value="5">â‘¥ ã€Œãªãœé£²é£Ÿã«ï¼Ÿã€ã‚’è£œè¶³ã™ã‚‹ç‰ˆ</option>
          <option value="6">â‘¦ çµŒå–¶è€…å‘ã‘ãƒ»ãƒ“ã‚¸ãƒã‚¹å¯„ã‚Šç‰ˆ</option>
          <option value="7">â‘§ æœ¬éƒ¨ãƒ»å¤§æ‰‹ä¼æ¥­å‘ã‘ç‰ˆ</option>
          <option value="8">â‘¨ æŸ”ã‚‰ã‹ã‚ï¼ˆå€‹äººçµŒå–¶å‘ã‘ï¼‰</option>
          <option value="9">â‘© ä¿¡é ¼ï¼‹ç¤¾ä¼šæ€§ã‚’å‡ºã™ç‰ˆ</option>
        </select>
      </div>

      <hr class="divider">

      <!-- æœ¬æ–‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»ç·¨é›† -->
      <div class="edit-area">
        <label>âœï¸ é€ä¿¡å†…å®¹ï¼ˆç·¨é›†å¯èƒ½ï¼‰</label>
        <textarea id="msgEdit" style="min-height:260px"></textarea>
      </div>
    </div>
    <div class="abar">
      <button class="btn btn-s" onclick="goStep(2)">â† æˆ»ã‚‹</button>
      <button class="btn btn-p" onclick="nextStep(3)">ç¢ºèªã¸ã€€â†’</button>
    </div>
  </div>

  <!-- STEP4 -->
  <div class="section" id="step4">
    <div class="card">
      <div class="ctitle"><span class="badge">4</span>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨é€ä¿¡ç¢ºèª</div>
      <div id="previewArea"><p style="color:var(--muted);font-size:.85rem;text-align:center;padding:20px 0">ã€Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å–å¾—ã€ã§å„ãƒ•ã‚©ãƒ¼ãƒ ã‚’è§£æã—ã¦å…¥åŠ›çŠ¶æ³ã‚’ç¢ºèªã§ãã¾ã™ã€‚</p></div>
      <div style="margin-top:16px">
        <button class="btn btn-s btn-sm" onclick="loadPreview()" id="prevBtn">ğŸ” ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å–å¾—</button>
      </div>
    </div>
    <div class="card" id="summaryCard" style="display:none">
      <div class="ctitle"><span class="badge" style="background:var(--success)">âœ“</span>é€ä¿¡æ¦‚è¦</div>
      <div id="summaryBody" style="font-size:.85rem;color:var(--muted);line-height:1.8"></div>
    </div>
    <div class="abar">
      <button class="btn btn-s" onclick="goStep(3)">â† æˆ»ã‚‹</button>
      <button class="btn btn-ok" onclick="confirmSend()">ğŸš€ é€ä¿¡å®Ÿè¡Œ</button>
    </div>
  </div>

  <!-- STEP5 å®Œäº† -->
  <div class="section" id="step5">
    <div class="card">
      <div class="result-summary">
        <div class="result-icon">ğŸ‰</div>
        <div class="result-title">é€ä¿¡å®Œäº†</div>
        <div class="result-sub">å„ä¼æ¥­ã®ãƒ•ã‚©ãƒ¼ãƒ ã¸ã®é€ä¿¡ãŒå®Œäº†ã—ã¾ã—ãŸ</div>
      </div>
      <div id="resultList"></div>
    </div>
    <div class="abar" style="margin-top:16px">
      <button class="btn btn-s btn-bl" onclick="resetAll()">ğŸ”„ æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™</button>
    </div>
  </div>
</div>

<div class="loading-overlay" id="loader">
  <div class="spinner"></div>
  <div class="ltext" id="ltxt">å‡¦ç†ä¸­...</div>
  <div class="lsub" id="lsub">ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„</div>
</div>

<div class="modal" id="modal">
  <div class="mbox">
    <div class="mtitle">âš ï¸ é€ä¿¡ç¢ºèª</div>
    <div class="mbody" id="mbody"></div>
    <div class="mactions">
      <button class="btn btn-s" style="flex:1" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-d" style="flex:1" onclick="doSend()">é€ä¿¡ã™ã‚‹</button>
    </div>
  </div>
</div>

<div class="toast-c" id="toastC"></div>

<script>
const API = (location.hostname==='localhost'||location.hostname==='127.0.0.1')?'http://localhost:3001':'';
let companies=[], selPattern=0, jobId=null;

// ===== ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼ =====
const KEY_SENDER = 'fb_sender';
const KEY_COMPANIES = 'fb_companies';

// ===== é€ä¿¡è€…æƒ…å ±ã®ä¿å­˜ãƒ»èª­è¾¼ =====
function saveSender() {
  const data = {
    name: document.getElementById('sName').value,
    company: document.getElementById('sCompany').value,
    email: document.getElementById('sEmail').value,
    phone: document.getElementById('sPhone').value,
  };
  localStorage.setItem(KEY_SENDER, JSON.stringify(data));
  showSaved('senderSaved');
}

function loadSender() {
  try {
    const d = JSON.parse(localStorage.getItem(KEY_SENDER)||'{}');
    if (d.name) document.getElementById('sName').value = d.name;
    if (d.company) document.getElementById('sCompany').value = d.company;
    if (d.email) document.getElementById('sEmail').value = d.email;
    if (d.phone) document.getElementById('sPhone').value = d.phone;
  } catch(e){}
}

// ===== ä¼æ¥­æƒ…å ±ã®ä¿å­˜ãƒ»èª­è¾¼ =====
function saveCompanies() {
  localStorage.setItem(KEY_COMPANIES, JSON.stringify(companies));
}

function loadCompanies() {
  try {
    const d = JSON.parse(localStorage.getItem(KEY_COMPANIES)||'[]');
    if (d.length) { companies = d; renderCompanies(); }
    else addCompany();
  } catch(e){ addCompany(); }
}

function showSaved(id) {
  const el = document.getElementById(id);
  if (!el) return;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2000);
}
// ===== ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ =====
const patterns = [
  {
    id:0, label:'A ã‚«ãƒ•ã‚§å‘ã‘',
    title:'ã€å¹³æ—¥é›†å®¢å¼·åŒ–ã€‘æˆæœå ±é…¬å‹ãƒ»æ–°ãŸãªäºˆç´„å°ç·šã®ã”ææ¡ˆ',
    body:`çªç„¶ã®ã”é€£çµ¡å¤±ç¤¼ã„ãŸã—ã¾ã™ã€‚
æ ªå¼ä¼šç¤¾ãƒªãƒ­ã‚¯ãƒ©ãƒ–ã¨ç”³ã—ã¾ã™ã€‚

ã‚«ãƒ•ã‚§æ¥­æ…‹æ§˜å‘ã‘ã«ã€å¹³æ—¥ã‚„ã‚¢ã‚¤ãƒ‰ãƒ«ã‚¿ã‚¤ãƒ ã®é›†å®¢å¼·åŒ–ã«ã¤ãªãŒã‚‹å®Œå…¨æˆæœå ±é…¬å‹ã®äºˆç´„å°å¸³ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã”ææ¡ˆã—ã¦ãŠã‚Šã¾ã™ã€‚

æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€
ãƒ»åˆæœŸè²»ç”¨ï¼æœˆé¡è²»ç”¨ãªã—
ãƒ»äºˆç´„ç™ºç”Ÿæ™‚ã®ã¿1åã‚ãŸã‚Š100å††
ãƒ»ç´„2,300ä¸‡äººãŒåˆ©ç”¨ã™ã‚‹ç¦åˆ©åšç”Ÿãƒ¡ãƒ‡ã‚£ã‚¢ã¸æ²è¼‰
ãƒ»Instagramä¸Šã¸ã®å¸­äºˆç´„ãƒœã‚¿ãƒ³è¨­ç½®ï¼ˆå›½å†…ã§ã‚‚é™ã‚‰ã‚ŒãŸä¼æ¥­ã®ã¿å¯¾å¿œï¼‰

ä¼æ¥­å‹¤å‹™å±¤ã®ä¼šå“¡æ§˜ãŒå¤šã„ãŸã‚ã€å¹³æ—¥ãƒ©ãƒ³ãƒåˆ©ç”¨ã‚„æ‰“ã¡åˆã‚ã›éœ€è¦ã®ç²å¾—ãŒæœŸå¾…ã§ãã¾ã™ã€‚

æ—¢å­˜ã®SNSé‹ç”¨ã‚„é›†å®¢æ–½ç­–ã«"è¿½åŠ ã™ã‚‹ã ã‘"ã§ã€æ–°ãŸãªäºˆç´„å°ç·šã‚’æ§‹ç¯‰ã„ãŸã ã‘ã‚‹ä»•çµ„ã¿ã§ã™ã€‚

ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã«ã¦40åˆ†ã»ã©ã€å…·ä½“çš„ãªå°å…¥æ–¹æ³•ã‚’ã”èª¬æ˜ã•ã›ã¦ã„ãŸã ã‘ã¾ã›ã‚“ã§ã—ã‚‡ã†ã‹ã€‚
ç›´è¿‘ã§ã¯ã€‡æœˆã€‡æ—¥ï¼ˆã€‡ï¼‰ï¼ã€‡æ—¥ï¼ˆã€‡ï¼‰ã§èª¿æ•´å¯èƒ½ã§ã™ã€‚
ä½•å’ã‚ˆã‚ã—ããŠé¡˜ã„ç”³ã—ä¸Šã’ã¾ã™ã€‚

æ ªå¼ä¼šç¤¾ãƒªãƒ­ã‚¯ãƒ©ãƒ–`
  },
  {
    id:1, label:'B é«˜å˜ä¾¡ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³',
    title:'ã€å®¢å±¤ã‚’åºƒã’ã‚‹æ–°ãŸãªäºˆç´„å°ç·šã€‘æˆæœå ±é…¬å‹ã‚µãƒ¼ãƒ“ã‚¹ã®ã”ææ¡ˆ',
    body:`çªç„¶ã®ã”é€£çµ¡å¤±ç¤¼ã„ãŸã—ã¾ã™ã€‚
æ ªå¼ä¼šç¤¾ãƒªãƒ­ã‚¯ãƒ©ãƒ–ã¨ç”³ã—ã¾ã™ã€‚

è²´ç¤¾ã®ã‚ˆã†ãªé«˜å“è³ªãªé£²é£Ÿåº—æ§˜å‘ã‘ã«ã€å®¢å±¤ã‚’åºƒã’ã‚‹æ–°ãŸãªäºˆç´„å°ç·šã¨ã—ã¦å®Œå…¨æˆæœå ±é…¬å‹ã®äºˆç´„ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã”ææ¡ˆã—ã¦ãŠã‚Šã¾ã™ã€‚

æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€
ãƒ»åˆæœŸè²»ç”¨ï¼æœˆé¡è²»ç”¨ãªã—
ãƒ»äºˆç´„ç™ºç”Ÿæ™‚ã®ã¿1åã‚ãŸã‚Š100å††
ãƒ»ç´„2,300ä¸‡äººã®ä¼æ¥­ä¼šå“¡æ§˜ã¸ã®åº—èˆ—æ²è¼‰
ãƒ»Instagramä¸Šã¸ã®å¸­äºˆç´„ãƒœã‚¿ãƒ³è¨­ç½®å¯¾å¿œ

ç¦åˆ©åšç”Ÿä¼šå“¡ã¯ä¼æ¥­å‹¤å‹™å±¤ãŒä¸­å¿ƒã®ãŸã‚ã€è½ã¡ç€ã„ãŸå®¢å±¤ã®æ–°è¦æ¥åº—ä¿ƒé€²ãŒæœŸå¾…ã§ãã¾ã™ã€‚
ãƒ–ãƒ©ãƒ³ãƒ‰ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æãªã†ã“ã¨ãªãã€æ–°è¦äºˆç´„ãƒãƒ£ãƒãƒ«ã‚’è¿½åŠ ã„ãŸã ã‘ã‚‹ä»•çµ„ã¿ã§ã™ã€‚

ãœã²ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã«ã¦40åˆ†ã»ã©ã€è©³ç´°ã‚’ã”èª¬æ˜ã•ã›ã¦ã„ãŸã ã‘ã¾ã™ã¨å¹¸ã„ã§ã™ã€‚
ç›´è¿‘ã§ã¯ã€‡æœˆã€‡æ—¥ï¼ˆã€‡ï¼‰ï¼ã€‡æ—¥ï¼ˆã€‡ï¼‰ã§èª¿æ•´å¯èƒ½ã§ã™ã€‚
ä½•å’ã‚ˆã‚ã—ããŠé¡˜ã„ç”³ã—ä¸Šã’ã¾ã™ã€‚

æ ªå¼ä¼šç¤¾ãƒªãƒ­ã‚¯ãƒ©ãƒ–`
  },
  {
    id:2, label:'C å±…é…’å±‹ãƒã‚§ãƒ¼ãƒ³',
    title:'ã€å®´ä¼šãƒ»å›£ä½“äºˆç´„å¼·åŒ–ã€‘æˆæœå ±é…¬å‹äºˆç´„å°ç·šã®ã”ææ¡ˆ',
    body:`çªç„¶ã®ã”é€£çµ¡å¤±ç¤¼ã„ãŸã—ã¾ã™ã€‚
æ ªå¼ä¼šç¤¾ãƒªãƒ­ã‚¯ãƒ©ãƒ–ã¨ç”³ã—ã¾ã™ã€‚

å®´ä¼šãƒ»å›£ä½“åˆ©ç”¨ã®é›†å®¢å¼·åŒ–ã‚’ã”æ”¯æ´ã§ãã‚‹å®Œå…¨æˆæœå ±é…¬å‹ã®äºˆç´„å°å¸³ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã”ææ¡ˆã—ã¦ãŠã‚Šã¾ã™ã€‚

æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€
ãƒ»åˆæœŸè²»ç”¨ï¼æœˆé¡è²»ç”¨ãªã—
ãƒ»äºˆç´„ç™ºç”Ÿæ™‚ã®ã¿1åã‚ãŸã‚Š100å††
ãƒ»å…¨å›½ç´„2,300ä¸‡äººãŒåˆ©ç”¨ã™ã‚‹ç¦åˆ©åšç”Ÿãƒ¡ãƒ‡ã‚£ã‚¢ã¸æ²è¼‰
ãƒ»Instagramå¸­äºˆç´„ãƒœã‚¿ãƒ³è¨­ç½®ï¼ˆå›½å†…ã§ã‚‚é™ã‚‰ã‚ŒãŸä¼æ¥­ã®ã¿å¯¾å¿œï¼‰

ä¼æ¥­ä¼šå“¡æ§˜ã®åˆ©ç”¨ãŒå¤šã„ãŸã‚ã€å®´ä¼šãƒ»ä¼šé£Ÿãƒ»æ‡‡è¦ªä¼šéœ€è¦ã®ç²å¾—ã«ã‚‚ã¤ãªãŒã‚Šã¾ã™ã€‚
æ—¢å­˜ã®é›†å®¢æ–½ç­–ã«è¿½åŠ ã™ã‚‹å½¢ã§ã€ãƒªã‚¹ã‚¯ãªãäºˆç´„å°ç·šã‚’æ‹¡å¼µã„ãŸã ã‘ã¾ã™ã€‚

ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã«ã¦40åˆ†ã»ã©ã€å…·ä½“çš„ãªé€å®¢äº‹ä¾‹ã‚’ã”ç´¹ä»‹ã•ã›ã¦ã„ãŸã ã‘ã¾ã›ã‚“ã§ã—ã‚‡ã†ã‹ã€‚
ç›´è¿‘ã§ã¯ã€‡æœˆã€‡æ—¥ï¼ˆã€‡ï¼‰ï¼ã€‡æ—¥ï¼ˆã€‡ï¼‰ã§èª¿æ•´å¯èƒ½ã§ã™ã€‚
ä½•å’ã‚ˆã‚ã—ããŠé¡˜ã„ç”³ã—ä¸Šã’ã¾ã™ã€‚

æ ªå¼ä¼šç¤¾ãƒªãƒ­ã‚¯ãƒ©ãƒ–`
  },
  {
    id:3, label:'D ãƒã‚§ãƒ¼ãƒ³æœ¬éƒ¨',
    title:'ã€è¤‡æ•°åº—èˆ—å¯¾å¿œå¯ã€‘æˆæœå ±é…¬å‹ãƒ»äºˆç´„å°ç·šå¼·åŒ–ã®ã”ææ¡ˆ',
    body:`çªç„¶ã®ã”é€£çµ¡å¤±ç¤¼ã„ãŸã—ã¾ã™ã€‚
æ ªå¼ä¼šç¤¾ãƒªãƒ­ã‚¯ãƒ©ãƒ–ã¨ç”³ã—ã¾ã™ã€‚

è¤‡æ•°åº—èˆ—ã‚’å±•é–‹ã•ã‚Œã¦ã„ã‚‹ä¼æ¥­æ§˜å‘ã‘ã«ã€å…¨åº—ã§æ´»ç”¨å¯èƒ½ãªã€Œå®Œå…¨æˆæœå ±é…¬å‹ã€äºˆç´„å°å¸³ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã”ææ¡ˆã—ã¦ãŠã‚Šã¾ã™ã€‚

æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€
ãƒ»åˆæœŸè²»ç”¨ï¼æœˆé¡è²»ç”¨ãªã—
ãƒ»äºˆç´„ç™ºç”Ÿæ™‚ã®ã¿1åã‚ãŸã‚Š100å††
ãƒ»ç´„2,300ä¸‡äººãŒåˆ©ç”¨ã™ã‚‹ç¦åˆ©åšç”Ÿãƒ¡ãƒ‡ã‚£ã‚¢ã¸ã®ä¸€æ‹¬æ²è¼‰
ãƒ»Instagramå¸­äºˆç´„ãƒœã‚¿ãƒ³ã®è¨­ç½®å¯¾å¿œï¼ˆå›½å†…ã§ã‚‚é™ã‚‰ã‚ŒãŸä¼æ¥­ã®ã¿ï¼‰

å„åº—èˆ—ã®äºˆç´„å°ç·šã‚’å¼·åŒ–ã—ãªãŒã‚‰ã€æœ¬éƒ¨æ§˜ã§ã®ä¸€å…ƒç®¡ç†ã‚‚å¯èƒ½ã§ã™ã€‚
æ—¢å­˜æ–½ç­–ã«è¿½åŠ ã™ã‚‹å½¢ã§å°å…¥ã„ãŸã ã‘ã‚‹ãŸã‚ã€ãƒªã‚¹ã‚¯ã‚’æŠ‘ãˆã¦å…¨åº—å±•é–‹ã‚’ã”æ¤œè¨ã„ãŸã ã‘ã¾ã™ã€‚

ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã«ã¦40åˆ†ã»ã©ã€å…·ä½“çš„ãªå°å…¥ãƒ•ãƒ­ãƒ¼ã‚’ã”èª¬æ˜ã•ã›ã¦ã„ãŸã ã‘ã¾ã›ã‚“ã§ã—ã‚‡ã†ã‹ã€‚
ç›´è¿‘ã§ã¯ã€‡æœˆã€‡æ—¥ï¼ˆã€‡ï¼‰ï¼ã€‡æ—¥ï¼ˆã€‡ï¼‰ã§èª¿æ•´å¯èƒ½ã§ã™ã€‚

ãªãŠã€æœ¬ä»¶ã®ã”æ‹…å½“è€…æ§˜ãŒåˆ¥ã«ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã—ãŸã‚‰ã€ãŠæ‰‹æ•°ã§ã™ãŒã”å…±æœ‰ï¼ˆã”è»¢é€ï¼‰ã„ãŸã ã‘ã¾ã™ã¨å¹¸ã„ã§ã™ã€‚
ä½•å’ã‚ˆã‚ã—ããŠé¡˜ã„ç”³ã—ä¸Šã’ã¾ã™ã€‚

æ ªå¼ä¼šç¤¾ãƒªãƒ­ã‚¯ãƒ©ãƒ–`
  }
];

const companyDescs = [
  'å¼Šç¤¾ã¯ã€å…¨å›½12,500ç¤¾ãƒ»ç´„2,300ä¸‡äººã®ä¼æ¥­ä¼šå“¡åŸºç›¤ã‚’æ´»ç”¨ã—ã€é£²é£Ÿåº—æ§˜ã¸ã®é€å®¢æ”¯æ´ã‚’è¡Œã£ã¦ã„ã‚‹ç¦åˆ©åšç”Ÿã‚µãƒ¼ãƒ“ã‚¹é‹å–¶ä¼šç¤¾ã§ã™ã€‚',
  'å¼Šç¤¾ã¯ã€ä¼æ¥­å‘ã‘ç¦åˆ©åšç”Ÿã‚µãƒ¼ãƒ“ã‚¹ã‚’æä¾›ã—ã¦ãŠã‚Šã€å…¨å›½12,500ç¤¾ãƒ»ç´„2,300ä¸‡äººã®ä¼šå“¡æ§˜ã«ã”åˆ©ç”¨ã„ãŸã ã„ã¦ãŠã‚Šã¾ã™ã€‚',
  'å¼Šç¤¾ã¯ã€æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ä¸Šå ´ãƒªãƒ­ã‚°ãƒ«ãƒ¼ãƒ—ã®ä¸€å“¡ã¨ã—ã¦ã€ä¼æ¥­å‘ã‘ç¦åˆ©åšç”Ÿã‚µãƒ¼ãƒ“ã‚¹ã‚’æä¾›ã—ã¦ãŠã‚Šã€å…¨å›½12,500ç¤¾ãƒ»ç´„2,300ä¸‡äººã®ä¼šå“¡åŸºç›¤ã‚’æœ‰ã—ã¦ãŠã‚Šã¾ã™ã€‚',
  'å¼Šç¤¾ã¯ã€å…¨å›½12,500ç¤¾ãƒ»ç´„2,300ä¸‡äººãŒåˆ©ç”¨ã™ã‚‹å›½å†…æœ€å¤§ç´šã®ä¼æ¥­å‘ã‘ç¦åˆ©åšç”Ÿã‚µãƒ¼ãƒ“ã‚¹ã‚’é‹å–¶ã—ã¦ãŠã‚Šã¾ã™ã€‚',
  'å¼Šç¤¾ã¯ã€ä¼æ¥­ã®äººææˆ¦ç•¥ãƒ»ç¦åˆ©åšç”Ÿæ”¯æ´ã‚’å°‚é–€ã¨ã—ã€é•·å¹´ã«ã‚ãŸã‚Šå¤šãã®å¤§æ‰‹ä¼æ¥­æ§˜ã«ã”å°å…¥ã„ãŸã ã„ã¦ã„ã‚‹ç¦åˆ©åšç”Ÿã‚µãƒ¼ãƒ“ã‚¹é‹å–¶ä¼šç¤¾ã§ã™ã€‚',
  'å¼Šç¤¾ã¯ä¼æ¥­å‘ã‘ç¦åˆ©åšç”Ÿã‚µãƒ¼ãƒ“ã‚¹ã‚’é‹å–¶ã—ã¦ãŠã‚Šã€ä¼šå“¡æ§˜ã®åˆ©ç”¨ä¿ƒé€²ã®ä¸€ç’°ã¨ã—ã¦é£²é£Ÿåº—æ§˜ã¸ã®é€å®¢æ”¯æ´ã‚‚è¡Œã£ã¦ãŠã‚Šã¾ã™ã€‚',
  'å¼Šç¤¾ã¯ã€ä¼æ¥­å‘ã‘ç¦åˆ©åšç”Ÿã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æä¾›ã—ã€ç´„2,300ä¸‡äººã®ä¼šå“¡ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’æ´»ç”¨ã—ãŸãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æ”¯æ´ã‚’è¡Œã£ã¦ãŠã‚Šã¾ã™ã€‚',
  'å¼Šç¤¾ã¯ã€å…¨å›½è¦æ¨¡ã§ä¼æ¥­å‘ã‘ç¦åˆ©åšç”Ÿã‚µãƒ¼ãƒ“ã‚¹ã‚’å±•é–‹ã—ã€12,500ç¤¾ãƒ»ç´„2,300ä¸‡äººã®ä¼šå“¡ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ´»ç”¨ã—ãŸé›†å®¢æ”¯æ´ã‚’è¡Œã£ã¦ãŠã‚Šã¾ã™ã€‚',
  'å¼Šç¤¾ã¯ã€ä¼æ¥­ã§åƒãæ–¹ã€…å‘ã‘ã®ç¦åˆ©åšç”Ÿã‚µãƒ¼ãƒ“ã‚¹ã‚’é‹å–¶ã—ã¦ãŠã‚Šã€å¤šãã®ä¼šå“¡æ§˜ã«æ—¥å¸¸åˆ©ç”¨ã„ãŸã ã„ã¦ãŠã‚Šã¾ã™ã€‚',
  'å¼Šç¤¾ã¯ã€ä¼æ¥­ã¨å¾“æ¥­å“¡ã®æº€è¶³åº¦å‘ä¸Šã‚’ç›®çš„ã¨ã—ãŸç¦åˆ©åšç”Ÿã‚µãƒ¼ãƒ“ã‚¹ã‚’å…¨å›½è¦æ¨¡ã§å±•é–‹ã—ã¦ãŠã‚Šã¾ã™ã€‚',
];

// æ¥­æ…‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åˆ¤å®š
function detectPattern(url, siteName) {
  const t = (url + ' ' + siteName).toLowerCase();
  if (/ãƒã‚§ãƒ¼ãƒ³|æœ¬éƒ¨|holdings|hd|ã‚°ãƒ«ãƒ¼ãƒ—|å¤šåº—èˆ—|franchise/.test(t)) return 3;
  if (/å±…é…’å±‹|izakaya|å®´ä¼š|banquet|ç„¼è‚‰|ç„¼ãé³¥|ä¸²/.test(t)) return 2;
  if (/ãƒ•ãƒ¬ãƒ³ãƒ|ã‚¤ã‚¿ãƒªã‚¢ãƒ³|é‰„æ¿|å‰²çƒ¹|æ‡çŸ³|é«˜ç´š|premium|fine/.test(t)) return 1;
  if (/ã‚«ãƒ•ã‚§|cafe|ã‚³ãƒ¼ãƒ’ãƒ¼|coffee|ãƒ™ãƒ¼ã‚«ãƒªãƒ¼|bakery|ã‚¹ã‚¤ãƒ¼ãƒ„/.test(t)) return 0;
  return null;
}

function buildMessage(patternId, descId) {
  const p = patterns[patternId];
  const desc = companyDescs[descId];
  // ã€Œæ ªå¼ä¼šç¤¾ãƒªãƒ­ã‚¯ãƒ©ãƒ–ã¨ç”³ã—ã¾ã™ã€‚ã€ã®å¾Œã«1è¡Œé–‹ã‘ã¦ä¼šç¤¾æ¦‚è¦ã‚’æŒ¿å…¥
  const bodyWithDesc = p.body.replace(
    'æ ªå¼ä¼šç¤¾ãƒªãƒ­ã‚¯ãƒ©ãƒ–ã¨ç”³ã—ã¾ã™ã€‚',
    'æ ªå¼ä¼šç¤¾ãƒªãƒ­ã‚¯ãƒ©ãƒ–ã¨ç”³ã—ã¾ã™ã€‚\n\n' + desc
  );
  return p.title + '\n\n' + bodyWithDesc;
}

function updatePreview() {
  const descId = parseInt(document.getElementById('companyDescSel').value);
  document.getElementById('msgEdit').value = buildMessage(selPattern, descId);
}

function renderPatterns(autoId) {
  const row = document.getElementById('patternRow');
  row.innerHTML = patterns.map((p,i) => {
    const isAuto = i === autoId;
    const isSel = i === selPattern;
    return `<span class="pattern-chip ${isSel?'sel':''} ${isAuto&&!isSel?'auto':''}" onclick="selectPattern(${i})">${p.label}${isAuto?' ğŸ¤–':''}</span>`;
  }).join('');
  const hint = document.getElementById('aiHint');
  hint.style.display = autoId !== null ? 'block' : 'none';
}

function selectPattern(id) {
  selPattern = id;
  renderPatterns(null);
  updatePreview();
}

// ===== åˆæœŸåŒ– =====
function init() {
  selPattern = 0;
  renderPatterns(null);
  updatePreview();
  loadSender();
  loadCompanies();
  // é€ä¿¡è€…æƒ…å ±ã®è‡ªå‹•ä¿å­˜ï¼ˆå…¥åŠ›ã®ãŸã³ã«ï¼‰
  ['sName','sCompany','sEmail','sPhone'].forEach(id=>{
    document.getElementById(id).addEventListener('input', saveSender);
  });
  checkServer();
  setInterval(checkServer, 10000);
}

async function checkServer() {
  try {
    const r = await fetch(API+'/api/health', {signal:AbortSignal.timeout(3000)});
    if (r.ok) { document.getElementById('sdot').className='sdot on'; document.getElementById('stxt').textContent='ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šæ¸ˆã¿'; }
  } catch { document.getElementById('sdot').className='sdot'; document.getElementById('stxt').textContent='æœªæ¥ç¶š'; }
}

// ===== ã‚¹ãƒ†ãƒƒãƒ—ç®¡ç† =====
function goStep(n) {
  document.querySelectorAll('.section').forEach((s,i)=>s.classList.toggle('active',i+1===n));
  document.querySelectorAll('.sbtn').forEach((b,i)=>{
    b.classList.remove('active','done');
    if(i+1===n) b.classList.add('active');
    else if(i+1<n) b.classList.add('done');
  });
  window.scrollTo({top:0,behavior:'smooth'});
}

function nextStep(n) {
  if (n===1) {
    if (!document.getElementById('sName').value.trim()||!document.getElementById('sEmail').value.trim()||!document.getElementById('sCompany').value.trim()) {
      return toast('ãŠåå‰ãƒ»ä¼šç¤¾åãƒ»ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','error');
    }
  }
  if (n===2) {
    const valid = companies.filter(c=>c.url);
    if (!valid.length) return toast('ä¼æ¥­URLã‚’å°‘ãªãã¨ã‚‚1ä»¶å…¥åŠ›ã—ã¦ãã ã•ã„','error');

    // AIæ¥­æ…‹åˆ¤å®š
    let autoId = null;
    for (const c of valid) {
      const id = detectPattern(c.url, c.name);
      if (id !== null) { autoId = id; break; }
    }
    if (autoId !== null && autoId !== selPattern) {
      selPattern = autoId;
    }
    renderPatterns(autoId);
    updatePreview();
  }
  if (n===3) {
    buildSummary();
  }
  goStep(n+1);
}

// ===== ä¼æ¥­ç®¡ç† =====
function addCompany() {
  if (companies.length>=10) return toast('æœ€å¤§10ç¤¾ã¾ã§ç™»éŒ²ã§ãã¾ã™','info');
  companies.push({id:'c'+Date.now(), name:'', url:'', sent:false, sentAt:''});
  renderCompanies();
  saveCompanies();
}
function removeCompany(id) {
  companies=companies.filter(c=>c.id!==id);
  renderCompanies();
  saveCompanies();
}

function deleteChecked() {
  const checked = [...document.querySelectorAll('.cchk:checked')].map(el=>el.dataset.id);
  if (!checked.length) return toast('å‰Šé™¤ã™ã‚‹ä¼æ¥­ã‚’é¸æŠã—ã¦ãã ã•ã„','info');
  if (!confirm(checked.length+'ç¤¾ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  companies = companies.filter(c=>!checked.includes(c.id));
  renderCompanies();
  saveCompanies();
  toast(checked.length+'ç¤¾ã‚’å‰Šé™¤ã—ã¾ã—ãŸ','success');
}
function updateCompany(id,f,v) {
  const c=companies.find(c=>c.id===id);
  if(c) { c[f]=v; saveCompanies(); showSaved('companiesSaved'); }
}
function renderCompanies() {
  const hasAny = companies.length > 0;
  let html = '';
  if (hasAny) {
    html += `<div class="del-bar">
      <input type="checkbox" class="chk" id="chkAll" onchange="toggleAllChk(this.checked)" title="å…¨é¸æŠ">
      <label for="chkAll" style="font-size:.78rem;color:var(--muted);cursor:pointer">å…¨é¸æŠ</label>
      <button class="del-btn-mini" onclick="deleteChecked()">ğŸ—‘ é¸æŠå‰Šé™¤</button>
      <span style="font-size:.72rem;color:var(--muted);margin-left:auto">${companies.length}/10ç¤¾</span>
    </div>`;
  }
  html += companies.map((c,i)=>`
    <div class="ccard ${c.sent?'sent':''}" id="cc_${c.id}">
      <div class="ccard-h">
        <input type="checkbox" class="chk cchk" data-id="${c.id}">
        <div class="cnum">${i+1}</div>
        <div class="cname" id="cn_${c.id}">${c.name||'ä¼æ¥­ '+(i+1)}</div>
        ${c.sent
          ? `<span class="sent-badge">âœ“ é€ä»˜æ¸ˆ ${c.sentAt?'<span style="font-weight:400;font-size:.65rem">'+c.sentAt+'</span>':''}</span>`
          : `<span class="unsent-badge">æœªé€ä»˜</span>`}
        <button class="rbtn" onclick="removeCompany('${c.id}')">âœ•</button>
      </div>
      <div class="cfields">
        <div class="fg"><label>ä¼šç¤¾å</label>
          <input type="text" value="${c.name}" placeholder="æ ªå¼ä¼šç¤¾â—‹â—‹"
            oninput="updateCompany('${c.id}','name',this.value);document.getElementById('cn_${c.id}').textContent=this.value||'ä¼æ¥­ ${i+1}'"/>
        </div>
        <div class="fg"><label>å•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ URL *</label>
          <input type="url" value="${c.url}" placeholder="https://example.com/contact"
            oninput="updateCompany('${c.id}','url',this.value)"/>
        </div>
      </div>
    </div>`).join('');
  document.getElementById('companyList').innerHTML = html;
  document.getElementById('addBtn').style.display = companies.length>=10?'none':'flex';
}

function toggleAllChk(checked) {
  document.querySelectorAll('.cchk').forEach(el=>el.checked=checked);
}

// ===== é€ä¿¡æ¦‚è¦ =====
function buildSummary() {
  const valid = companies.filter(c=>c.url);
  document.getElementById('summaryCard').style.display='block';
  document.getElementById('summaryBody').innerHTML =
    `<strong style="color:var(--text)">é€ä¿¡è€…ï¼š</strong>${document.getElementById('sName').value}ï¼ˆ${document.getElementById('sCompany').value}ï¼‰<br>
     <strong style="color:var(--text)">ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼š</strong>${patterns[selPattern].label}<br>
     <strong style="color:var(--text)">é€ä¿¡å…ˆï¼š</strong>${valid.map(c=>c.name||c.url).join('ã€')}<br>
     <strong style="color:var(--text)">å¯¾è±¡ç¤¾æ•°ï¼š</strong>${valid.length}ç¤¾`;
}

// ===== ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ =====
async function loadPreview() {
  const valid = companies.filter(c=>c.url);
  if (!valid.length) return toast('ä¼æ¥­URLã‚’è¨­å®šã—ã¦ãã ã•ã„','error');
  showLoader('ãƒ•ã‚©ãƒ¼ãƒ ã‚’è§£æä¸­...','å„ä¼æ¥­ã‚µã‚¤ãƒˆã‚’é–‹ã„ã¦ã„ã¾ã™...');
  document.getElementById('prevBtn').disabled=true;
  try {
    const r = await fetch(API+'/api/preview',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({companies:valid,senderInfo:getSenderInfo(),messageTemplate:{content:document.getElementById('msgEdit').value}})});
    const d = await r.json();
    jobId=d.jobId;
    pollJob(d.jobId);
  } catch {
    hideLoader();
    toast('ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“','error');
    document.getElementById('prevBtn').disabled=false;
  }
}
async function pollJob(id) {
  const r = await fetch(API+'/api/job/'+id);
  const j = await r.json();
  if (j.status!=='done'&&j.status!=='error') { setTimeout(()=>pollJob(id),2000); return; }
  hideLoader();
  document.getElementById('prevBtn').disabled=false;
  renderPreviews(j);
}
function renderPreviews(job) {
  const msgContent = document.getElementById('msgEdit').value;
  let h='';
  for (const p of job.previews) {
    const filled=(p.fillResults?.filled||[]);
    const nf=(p.fillResults?.notFound||[]);
    h+=`<div class="preview-item">
      <div class="pitem-h"><div class="pname">${p.companyName||p.url}</div><span class="sbadge ready">è§£æå®Œäº†</span></div>
      <div class="pdetail">
        <div style="margin-bottom:8px">å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼š${filled.map(f=>`<span class="ftag ok">âœ“ ${f.field}</span>`).join('')}${nf.map(f=>`<span class="ftag ng">âœ• ${f}</span>`).join('')}</div>
        <div style="margin-top:12px;border-top:1px solid var(--border);padding-top:12px">
          <div style="font-size:.75rem;color:var(--accent);font-weight:700;margin-bottom:8px">ğŸ“„ é€ä¿¡å†…å®¹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
          <div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px;font-size:.8rem;line-height:1.8;white-space:pre-wrap;color:var(--text)">${msgContent.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
        </div>
      </div>
    </div>`;
  }
  for (const e of job.errors) {
    h+=`<div class="preview-item"><div class="pitem-h"><div class="pname">${e.company}</div><span class="sbadge error">ã‚¨ãƒ©ãƒ¼</span></div>
    <div class="pdetail">
      <div style="color:var(--danger);margin-bottom:12px">${e.error}</div>
      <div style="border-top:1px solid var(--border);padding-top:12px">
        <div style="font-size:.75rem;color:var(--accent);font-weight:700;margin-bottom:8px">ğŸ“„ é€ä¿¡äºˆå®šå†…å®¹</div>
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px;font-size:.8rem;line-height:1.8;white-space:pre-wrap;color:var(--text)">${msgContent.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
      </div>
    </div></div>`;
  }
  document.getElementById('previewArea').innerHTML=h||'<p style="color:var(--muted);text-align:center;padding:20px">çµæœãŒã‚ã‚Šã¾ã›ã‚“</p>';
}

// ===== é€ä¿¡ =====
function getSenderInfo(){return{name:document.getElementById('sName').value,company:document.getElementById('sCompany').value,email:document.getElementById('sEmail').value,phone:document.getElementById('sPhone').value};}
function confirmSend() {
  const valid=companies.filter(c=>c.url);
  document.getElementById('mbody').innerHTML=`ä»¥ä¸‹ã®<strong>${valid.length}ç¤¾</strong>ã«é€ä¿¡ã—ã¾ã™ã€‚<br><br>${valid.map(c=>`ãƒ»${c.name||c.url}`).join('<br>')}<br><br>âš ï¸ ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`;
  document.getElementById('modal').classList.add('active');
}
function closeModal(){document.getElementById('modal').classList.remove('active');}
async function doSend() {
  closeModal();
  showLoader('é€ä¿¡ä¸­...','å„ä¼æ¥­ã®ãƒ•ã‚©ãƒ¼ãƒ ã«é€ä¿¡ã—ã¦ã„ã¾ã™...');
  const valid=companies.filter(c=>c.url);
  try {
    const r=await fetch(API+'/api/submit',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({companies:valid,senderInfo:getSenderInfo(),messageTemplate:{content:document.getElementById('msgEdit').value},selectedCompanyIds:valid.map(c=>c.id)})});
    const d=await r.json();
    hideLoader();
    showResults(d.results);
  } catch { hideLoader(); toast('é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ','error'); }
}
function showResults(results) {
  goStep(5);
  const now = new Date();
  const dateStr = now.getFullYear()+'/'+(now.getMonth()+1).toString().padStart(2,'0')+'/'+now.getDate().toString().padStart(2,'0');
  // é€ä»˜æ¸ˆã¿ãƒ•ãƒ©ã‚°ã‚’æ›´æ–°
  results.forEach(r=>{
    if (r.status==='submitted') {
      const c = companies.find(c=>c.id===r.companyId);
      if (c) { c.sent=true; c.sentAt=dateStr; }
    }
  });
  saveCompanies();
  document.getElementById('resultList').innerHTML=results.map(r=>`
    <div class="preview-item"><div class="pitem-h"><div class="pname">${r.companyName}</div>
    <span class="sbadge ${r.status==='submitted'?'submitted':'error'}">${r.status==='submitted'?'âœ“ é€ä¿¡å®Œäº†':r.status==='no_fields'?'ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æœªæ¤œå‡º':'ã‚¨ãƒ©ãƒ¼'}</span></div>
    <div class="pdetail">${r.message||r.error||'æ­£å¸¸ã«é€ä¿¡ã•ã‚Œã¾ã—ãŸ'}</div></div>`).join('');
}

// ===== ãƒªã‚»ãƒƒãƒˆ =====
function resetAll(){
  selPattern=0;
  renderPatterns(null);
  updatePreview();
  renderCompanies();
  document.getElementById('summaryCard').style.display='none';
  document.getElementById('previewArea').innerHTML='<p style="color:var(--muted);font-size:.85rem;text-align:center;padding:20px 0">ã€Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å–å¾—ã€ã§å„ãƒ•ã‚©ãƒ¼ãƒ ã‚’è§£æã—ã¦å…¥åŠ›çŠ¶æ³ã‚’ç¢ºèªã§ãã¾ã™ã€‚</p>';
  goStep(1);
  toast('ä¼æ¥­ãƒªã‚¹ãƒˆã¯ä¿æŒã—ã¦ã„ã¾ã™','info');
}

// ===== UI =====
function showLoader(t,s){document.getElementById('ltxt').textContent=t;document.getElementById('lsub').textContent=s;document.getElementById('loader').classList.add('active');}
function hideLoader(){document.getElementById('loader').classList.remove('active');}
function toast(msg,type='info'){const c=document.getElementById('toastC');const t=document.createElement('div');t.className='toast '+type;t.textContent=msg;c.appendChild(t);setTimeout(()=>t.remove(),3500);}

init();
</script>
</body>
</html>
