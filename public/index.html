<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>FormBlast â€” å–¶æ¥­ãƒ•ã‚©ãƒ¼ãƒ è‡ªå‹•é€ä¿¡</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #12121a;
    --surface2: #1a1a26;
    --border: rgba(255,255,255,0.07);
    --accent: #4f7cff;
    --accent2: #a259ff;
    --success: #22d3a0;
    --warning: #f5a623;
    --danger: #ff4f6e;
    --text: #e8e8f0;
    --text-muted: #6b6b85;
    --glow: 0 0 30px rgba(79,124,255,0.15);
  }

- { box-sizing: border-box; margin: 0; padding: 0; }

body {
background: var(â€“bg);
color: var(â€“text);
font-family: â€˜Noto Sans JPâ€™, sans-serif;
min-height: 100vh;
overflow-x: hidden;
}

/* â”€â”€ èƒŒæ™¯ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ â”€â”€ */
body::before {
content: â€˜â€™;
position: fixed;
top: -30%;
left: -10%;
width: 60%;
height: 60%;
background: radial-gradient(ellipse, rgba(79,124,255,0.08) 0%, transparent 70%);
pointer-events: none;
z-index: 0;
}
body::after {
content: â€˜â€™;
position: fixed;
bottom: -20%;
right: -10%;
width: 50%;
height: 50%;
background: radial-gradient(ellipse, rgba(162,89,255,0.07) 0%, transparent 70%);
pointer-events: none;
z-index: 0;
}

/* â”€â”€ ãƒ˜ãƒƒãƒ€ãƒ¼ â”€â”€ */
header {
position: sticky;
top: 0;
z-index: 100;
backdrop-filter: blur(20px);
background: rgba(10,10,15,0.85);
border-bottom: 1px solid var(â€“border);
padding: 14px 20px;
display: flex;
align-items: center;
justify-content: space-between;
}

.logo {
font-family: â€˜Syneâ€™, sans-serif;
font-weight: 800;
font-size: 1.3rem;
letter-spacing: -0.02em;
background: linear-gradient(135deg, var(â€“accent), var(â€“accent2));
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
}

.status-dot {
width: 8px; height: 8px;
border-radius: 50%;
background: var(â€“text-muted);
display: inline-block;
margin-right: 6px;
transition: all 0.3s;
}
.status-dot.online { background: var(â€“success); box-shadow: 0 0 6px var(â€“success); }

/* â”€â”€ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ â”€â”€ */
.container {
position: relative;
z-index: 1;
max-width: 900px;
margin: 0 auto;
padding: 24px 16px 60px;
}

/* â”€â”€ ã‚¹ãƒ†ãƒƒãƒ—ãƒŠãƒ“ â”€â”€ */
.steps {
display: flex;
gap: 4px;
margin-bottom: 28px;
background: var(â€“surface);
border-radius: 14px;
padding: 6px;
border: 1px solid var(â€“border);
}

.step-btn {
flex: 1;
padding: 10px 6px;
border: none;
background: transparent;
color: var(â€“text-muted);
font-family: â€˜Noto Sans JPâ€™, sans-serif;
font-size: 0.72rem;
font-weight: 500;
border-radius: 10px;
cursor: pointer;
transition: all 0.25s;
text-align: center;
white-space: nowrap;
}

.step-btn.active {
background: linear-gradient(135deg, var(â€“accent), var(â€“accent2));
color: #fff;
font-weight: 700;
box-shadow: 0 2px 12px rgba(79,124,255,0.3);
}

.step-btn.done { color: var(â€“success); }

/* â”€â”€ ã‚«ãƒ¼ãƒ‰ â”€â”€ */
.card {
background: var(â€“surface);
border: 1px solid var(â€“border);
border-radius: 20px;
padding: 24px;
margin-bottom: 16px;
transition: border-color 0.3s;
}
.card:hover { border-color: rgba(79,124,255,0.2); }

.card-title {
font-family: â€˜Syneâ€™, sans-serif;
font-size: 1rem;
font-weight: 700;
margin-bottom: 18px;
display: flex;
align-items: center;
gap: 10px;
}

.badge {
display: inline-flex;
align-items: center;
justify-content: center;
width: 26px; height: 26px;
border-radius: 8px;
font-size: 0.75rem;
font-weight: 800;
background: linear-gradient(135deg, var(â€“accent), var(â€“accent2));
color: #fff;
flex-shrink: 0;
}

/* â”€â”€ ãƒ•ã‚©ãƒ¼ãƒ éƒ¨å“ â”€â”€ */
.form-group {
margin-bottom: 14px;
}

label {
display: block;
font-size: 0.78rem;
color: var(â€“text-muted);
margin-bottom: 6px;
font-weight: 500;
}

input[type=â€œtextâ€],
input[type=â€œemailâ€],
input[type=â€œtelâ€],
input[type=â€œurlâ€],
textarea {
width: 100%;
background: var(â€“surface2);
border: 1px solid var(â€“border);
border-radius: 12px;
padding: 12px 14px;
color: var(â€“text);
font-family: â€˜Noto Sans JPâ€™, sans-serif;
font-size: 0.92rem;
outline: none;
transition: border-color 0.2s, box-shadow 0.2s;
-webkit-appearance: none;
}

input:focus, textarea:focus {
border-color: var(â€“accent);
box-shadow: 0 0 0 3px rgba(79,124,255,0.1);
}

textarea { resize: vertical; min-height: 100px; line-height: 1.6; }

/* â”€â”€ ä¼æ¥­ã‚«ãƒ¼ãƒ‰ â”€â”€ */
.company-list { display: flex; flex-direction: column; gap: 12px; }

.company-card {
background: var(â€“surface2);
border: 1px solid var(â€“border);
border-radius: 16px;
padding: 16px;
position: relative;
transition: all 0.2s;
}

.company-card.selected {
border-color: var(â€“accent);
background: rgba(79,124,255,0.05);
}

.company-card-header {
display: flex;
align-items: center;
gap: 12px;
margin-bottom: 12px;
}

.company-num {
width: 28px; height: 28px;
border-radius: 8px;
background: var(â€“surface);
border: 1px solid var(â€“border);
display: flex;
align-items: center;
justify-content: center;
font-family: â€˜Syneâ€™, sans-serif;
font-size: 0.8rem;
font-weight: 700;
color: var(â€“text-muted);
flex-shrink: 0;
}

.company-name-display {
font-weight: 600;
font-size: 0.9rem;
flex: 1;
}

.remove-btn {
background: none;
border: none;
color: var(â€“text-muted);
cursor: pointer;
font-size: 1.1rem;
padding: 4px;
border-radius: 6px;
transition: color 0.2s;
}
.remove-btn:hover { color: var(â€“danger); }

.company-fields { display: flex; flex-direction: column; gap: 10px; }

/* â”€â”€ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ â”€â”€ */
.template-grid {
display: flex;
flex-direction: column;
gap: 10px;
}

.template-card {
background: var(â€“surface2);
border: 1.5px solid var(â€“border);
border-radius: 14px;
padding: 14px 16px;
cursor: pointer;
transition: all 0.2s;
position: relative;
}

.template-card:hover {
border-color: rgba(79,124,255,0.3);
transform: translateX(3px);
}

.template-card.selected {
border-color: var(â€“accent);
background: rgba(79,124,255,0.06);
}

.template-card.selected::before {
content: â€˜âœ“â€™;
position: absolute;
right: 14px;
top: 50%;
transform: translateY(-50%);
color: var(â€“accent);
font-weight: 700;
font-size: 1rem;
}

.template-title {
font-weight: 700;
font-size: 0.88rem;
margin-bottom: 4px;
}

.template-preview {
font-size: 0.77rem;
color: var(â€“text-muted);
line-height: 1.5;
overflow: hidden;
display: -webkit-box;
-webkit-line-clamp: 2;
-webkit-box-orient: vertical;
}

/* â”€â”€ ãƒœã‚¿ãƒ³ â”€â”€ */
.btn {
display: inline-flex;
align-items: center;
justify-content: center;
gap: 8px;
padding: 14px 24px;
border: none;
border-radius: 12px;
font-family: â€˜Noto Sans JPâ€™, sans-serif;
font-weight: 700;
font-size: 0.92rem;
cursor: pointer;
transition: all 0.2s;
text-decoration: none;
-webkit-tap-highlight-color: transparent;
}

.btn-primary {
background: linear-gradient(135deg, var(â€“accent), var(â€“accent2));
color: #fff;
box-shadow: 0 4px 20px rgba(79,124,255,0.3);
}
.btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 24px rgba(79,124,255,0.4); }
.btn-primary:active { transform: translateY(0); }

.btn-secondary {
background: var(â€“surface2);
border: 1px solid var(â€“border);
color: var(â€“text);
}
.btn-secondary:hover { border-color: var(â€“accent); }

.btn-success {
background: linear-gradient(135deg, var(â€“success), #0ea676);
color: #fff;
box-shadow: 0 4px 20px rgba(34,211,160,0.25);
}

.btn-danger {
background: linear-gradient(135deg, var(â€“danger), #c9304c);
color: #fff;
}

.btn-sm { padding: 8px 14px; font-size: 0.82rem; }

.btn-block { width: 100%; }

.btn:disabled {
opacity: 0.4;
cursor: not-allowed;
transform: none !important;
}

/* â”€â”€ è¿½åŠ ãƒœã‚¿ãƒ³ â”€â”€ */
.add-company-btn {
width: 100%;
padding: 14px;
background: transparent;
border: 1.5px dashed rgba(79,124,255,0.3);
border-radius: 16px;
color: var(â€“accent);
font-family: â€˜Noto Sans JPâ€™, sans-serif;
font-size: 0.88rem;
font-weight: 600;
cursor: pointer;
transition: all 0.2s;
display: flex;
align-items: center;
justify-content: center;
gap: 8px;
}
.add-company-btn:hover {
background: rgba(79,124,255,0.05);
border-color: var(â€“accent);
}

/* â”€â”€ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ¼ â”€â”€ */
.action-bar {
display: flex;
gap: 10px;
margin-top: 20px;
}
.action-bar .btn { flex: 1; }

/* â”€â”€ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ â”€â”€ */
.preview-list { display: flex; flex-direction: column; gap: 16px; }

.preview-item {
background: var(â€“surface2);
border: 1px solid var(â€“border);
border-radius: 16px;
overflow: hidden;
}

.preview-item-header {
padding: 14px 16px;
display: flex;
align-items: center;
gap: 10px;
border-bottom: 1px solid var(â€“border);
background: rgba(255,255,255,0.02);
}

.preview-company-name {
font-weight: 700;
font-size: 0.9rem;
flex: 1;
}

.status-badge {
font-size: 0.72rem;
font-weight: 700;
padding: 4px 10px;
border-radius: 20px;
}
.status-badge.loading { background: rgba(245,166,35,0.15); color: var(â€“warning); }
.status-badge.ready { background: rgba(34,211,160,0.15); color: var(â€“success); }
.status-badge.error { background: rgba(255,79,110,0.15); color: var(â€“danger); }
.status-badge.submitted { background: rgba(34,211,160,0.2); color: var(â€“success); }

.preview-screenshot {
width: 100%;
max-height: 280px;
object-fit: cover;
object-position: top;
display: block;
border-bottom: 1px solid var(â€“border);
}

.preview-details {
padding: 12px 16px;
font-size: 0.8rem;
color: var(â€“text-muted);
}

.fill-result {
display: flex;
flex-wrap: wrap;
gap: 6px;
margin-top: 8px;
}

.fill-tag {
padding: 3px 9px;
border-radius: 6px;
font-size: 0.72rem;
font-weight: 600;
}
.fill-tag.ok { background: rgba(34,211,160,0.12); color: var(â€“success); }
.fill-tag.ng { background: rgba(255,79,110,0.12); color: var(â€“danger); }

/* â”€â”€ ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° â”€â”€ */
.loading-overlay {
display: none;
position: fixed;
inset: 0;
z-index: 999;
background: rgba(10,10,15,0.85);
backdrop-filter: blur(8px);
align-items: center;
justify-content: center;
flex-direction: column;
gap: 20px;
}
.loading-overlay.active { display: flex; }

.spinner {
width: 48px; height: 48px;
border: 3px solid var(â€“border);
border-top-color: var(â€“accent);
border-radius: 50%;
animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

.loading-text {
font-family: â€˜Syneâ€™, sans-serif;
font-size: 1.1rem;
font-weight: 700;
color: var(â€“text);
}

.loading-sub {
font-size: 0.82rem;
color: var(â€“text-muted);
text-align: center;
max-width: 260px;
}

/* â”€â”€ ãƒˆãƒ¼ã‚¹ãƒˆ â”€â”€ */
.toast-container {
position: fixed;
bottom: 24px;
left: 50%;
transform: translateX(-50%);
z-index: 1000;
display: flex;
flex-direction: column;
gap: 10px;
align-items: center;
width: 90%;
max-width: 400px;
}

.toast {
background: var(â€“surface);
border: 1px solid var(â€“border);
border-radius: 14px;
padding: 12px 18px;
font-size: 0.85rem;
font-weight: 600;
box-shadow: 0 8px 32px rgba(0,0,0,0.4);
animation: slideUp 0.3s ease;
width: 100%;
text-align: center;
}
.toast.success { border-color: var(â€“success); color: var(â€“success); }
.toast.error { border-color: var(â€“danger); color: var(â€“danger); }
.toast.info { border-color: var(â€“accent); color: var(â€“accent); }

@keyframes slideUp {
from { opacity: 0; transform: translateY(20px); }
to { opacity: 1; transform: translateY(0); }
}

/* â”€â”€ ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« â”€â”€ */
.modal {
display: none;
position: fixed;
inset: 0;
z-index: 998;
background: rgba(10,10,15,0.9);
backdrop-filter: blur(10px);
align-items: flex-end;
justify-content: center;
padding: 20px;
}
.modal.active { display: flex; }

.modal-box {
background: var(â€“surface);
border: 1px solid var(â€“border);
border-radius: 24px 24px 0 0;
padding: 28px 24px;
width: 100%;
max-width: 480px;
animation: slideUp 0.3s ease;
}

.modal-title {
font-family: â€˜Syneâ€™, sans-serif;
font-size: 1.2rem;
font-weight: 800;
margin-bottom: 12px;
}

.modal-body {
font-size: 0.88rem;
color: var(â€“text-muted);
line-height: 1.6;
margin-bottom: 24px;
}

.modal-actions { display: flex; gap: 10px; }

/* â”€â”€ ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºåˆ‡æ›¿ â”€â”€ */
.section { display: none; }
.section.active { display: block; }

/* â”€â”€ ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– â”€â”€ */
@media (min-width: 600px) {
.template-grid { display: grid; grid-template-columns: 1fr 1fr; }
.company-fields { display: grid; grid-template-columns: 1fr 1fr; }
.modal { align-items: center; }
.modal-box { border-radius: 24px; }
.container { padding: 32px 24px 80px; }
}

/* â”€â”€ ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ãƒ•ãƒ«ã‚µã‚¤ã‚ºç”¨ â”€â”€ */
.full-width { grid-column: 1 / -1; }

/* â”€â”€ é€ä¿¡å®Œäº† â”€â”€ */
.result-summary {
text-align: center;
padding: 40px 20px;
}
.result-icon {
font-size: 3.5rem;
margin-bottom: 16px;
}
.result-title {
font-family: â€˜Syneâ€™, sans-serif;
font-size: 1.5rem;
font-weight: 800;
margin-bottom: 8px;
}
.result-sub { color: var(â€“text-muted); font-size: 0.88rem; }

.server-warning {
background: rgba(245,166,35,0.08);
border: 1px solid rgba(245,166,35,0.2);
border-radius: 12px;
padding: 12px 16px;
font-size: 0.8rem;
color: var(â€“warning);
margin-bottom: 20px;
line-height: 1.6;
}
</style>

</head>
<body>

<header>
  <div class="logo">âš¡ FormBlast</div>
  <div style="display:flex;align-items:center;font-size:0.78rem;color:var(--text-muted)">
    <span class="status-dot" id="statusDot"></span>
    <span id="statusText">æœªæ¥ç¶š</span>
  </div>
</header>

<div class="container">

  <!-- ã‚¹ãƒ†ãƒƒãƒ—ãƒŠãƒ“ -->

  <div class="steps">
    <button class="step-btn active" onclick="goToStep(1)" id="stepBtn1">â‘  é€ä¿¡è€…æƒ…å ±</button>
    <button class="step-btn" onclick="goToStep(2)" id="stepBtn2">â‘¡ ä¼æ¥­è¨­å®š</button>
    <button class="step-btn" onclick="goToStep(3)" id="stepBtn3">â‘¢ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</button>
    <button class="step-btn" onclick="goToStep(4)" id="stepBtn4">â‘£ ç¢ºèªãƒ»é€ä¿¡</button>
  </div>

  <!-- ========== STEP 1: é€ä¿¡è€…æƒ…å ± ========== -->

  <div class="section active" id="step1">
    <div class="card">
      <div class="card-title"><span class="badge">1</span>ã‚ãªãŸã®æƒ…å ±</div>

<div class="form-group">
        <label>ãŠåå‰ *</label>
        <input type="text" id="senderName" placeholder="å±±ç”° å¤ªéƒ" />
      </div>
      <div class="form-group">
        <label>ä¼šç¤¾å *</label>
        <input type="text" id="senderCompany" placeholder="æ ªå¼ä¼šç¤¾â—‹â—‹" />
      </div>
      <div class="form-group">
        <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ *</label>
        <input type="email" id="senderEmail" placeholder="yamada@example.com" />
      </div>
      <div class="form-group">
        <label>é›»è©±ç•ªå·</label>
        <input type="tel" id="senderPhone" placeholder="03-1234-5678" />
      </div>
    </div>
    <div class="action-bar">
      <button class="btn btn-primary btn-block" onclick="nextStep(1)">æ¬¡ã¸ã€€â†’</button>
    </div>
  </div>

  <!-- ========== STEP 2: ä¼æ¥­è¨­å®š ========== -->

  <div class="section" id="step2">
    <div class="card">
      <div class="card-title"><span class="badge">2</span>é€ä¿¡å…ˆä¼æ¥­ï¼ˆæœ€å¤§5ç¤¾ï¼‰</div>

```
  <div class="company-list" id="companyList"></div>

  <button class="add-company-btn" id="addCompanyBtn" onclick="addCompany()" style="margin-top:12px">
    <span>ï¼‹</span> ä¼æ¥­ã‚’è¿½åŠ ã™ã‚‹
  </button>
</div>
<div class="action-bar">
  <button class="btn btn-secondary" onclick="goToStep(1)">â† æˆ»ã‚‹</button>
  <button class="btn btn-primary" onclick="nextStep(2)">æ¬¡ã¸ã€€â†’</button>
</div>
```

  </div>

  <!-- ========== STEP 3: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ ========== -->

  <div class="section" id="step3">
    <div class="card">
      <div class="card-title"><span class="badge">3</span>é€ä¿¡å†…å®¹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</div>

```
  <div class="template-grid" id="templateGrid"></div>

  <div id="templateEditArea" style="margin-top:18px;display:none;">
    <div class="form-group">
      <label>ã‚«ã‚¹ã‚¿ãƒ ç·¨é›†ï¼ˆé¸æŠä¸­ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç·¨é›†å¯èƒ½ï¼‰</label>
      <textarea id="templateEdit" style="min-height:160px;"></textarea>
    </div>
  </div>
</div>
<div class="action-bar">
  <button class="btn btn-secondary" onclick="goToStep(2)">â† æˆ»ã‚‹</button>
  <button class="btn btn-primary" onclick="nextStep(3)">ç¢ºèªã¸ã€€â†’</button>
</div>
```

  </div>

  <!-- ========== STEP 4: ç¢ºèªãƒ»é€ä¿¡ ========== -->

  <div class="section" id="step4">
    <div class="card">
      <div class="card-title"><span class="badge">4</span>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨é€ä¿¡ç¢ºèª</div>

```
  <div id="previewArea">
    <p style="color:var(--text-muted);font-size:0.85rem;text-align:center;padding:20px 0">
      ã€Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å–å¾—ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€å„ä¼æ¥­ã®ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã„ã¦<br>è‡ªå‹•å…¥åŠ›ã—ãŸçŠ¶æ…‹ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ç¢ºèªã§ãã¾ã™ã€‚
    </p>
  </div>

  <div style="margin-top:16px;display:flex;gap:10px;flex-wrap:wrap;">
    <button class="btn btn-secondary btn-sm" onclick="loadPreview()" id="previewBtn">
      ğŸ” ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å–å¾—
    </button>
  </div>
</div>

<!-- é€ä¿¡æ¦‚è¦ -->
<div class="card" id="submitSummaryCard" style="display:none;">
  <div class="card-title"><span class="badge" style="background:var(--success)">âœ“</span>é€ä¿¡æ¦‚è¦</div>
  <div id="submitSummary" style="font-size:0.85rem;color:var(--text-muted);line-height:1.8;"></div>
</div>

<div class="action-bar">
  <button class="btn btn-secondary" onclick="goToStep(3)">â† æˆ»ã‚‹</button>
  <button class="btn btn-success" onclick="confirmSubmit()" id="submitBtn">
    ğŸš€ é€ä¿¡å®Ÿè¡Œ
  </button>
</div>
```

  </div>

  <!-- ========== STEP 5: å®Œäº† ========== -->

  <div class="section" id="step5">
    <div class="card">
      <div class="result-summary">
        <div class="result-icon">ğŸ‰</div>
        <div class="result-title">é€ä¿¡å®Œäº†</div>
        <div class="result-sub">å„ä¼æ¥­ã®ãƒ•ã‚©ãƒ¼ãƒ ã¸ã®é€ä¿¡ãŒå®Œäº†ã—ã¾ã—ãŸ</div>
      </div>
      <div id="resultList" class="preview-list"></div>
    </div>
    <div class="action-bar" style="margin-top:16px;">
      <button class="btn btn-secondary btn-block" onclick="resetAll()">ğŸ”„ æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™</button>
    </div>
  </div>

</div>

<!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->

<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-text" id="loadingTitle">å‡¦ç†ä¸­...</div>
  <div class="loading-sub" id="loadingSubText">ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„</div>
</div>

<!-- é€ä¿¡ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->

<div class="modal" id="confirmModal">
  <div class="modal-box">
    <div class="modal-title">âš ï¸ é€ä¿¡ç¢ºèª</div>
    <div class="modal-body" id="confirmModalBody">
      ä»¥ä¸‹ã®ä¼æ¥­ã«å•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰é€ä¿¡ã—ã¾ã™ã€‚<br>ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚æœ¬å½“ã«é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" style="flex:1" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-danger" style="flex:1" onclick="executeSubmit()">é€ä¿¡ã™ã‚‹</button>
    </div>
  </div>
</div>

<!-- ãƒˆãƒ¼ã‚¹ãƒˆ -->

<div class="toast-container" id="toastContainer"></div>

<script>
const API = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') ? 'http://localhost:3001' : '';
let currentStep = 1;
let companies = [];
let selectedTemplate = null;
let previewJobId = null;

// ========== ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ ==========
const templates = [
  {
    id: 1,
    title: 'ğŸ“Š ã‚µãƒ¼ãƒ“ã‚¹ç´¹ä»‹',
    preview: 'å¼Šç¤¾ã®ã‚µãƒ¼ãƒ“ã‚¹ã«ã¤ã„ã¦ã”ç´¹ä»‹ã•ã›ã¦ãã ã•ã„ã€‚è²´ç¤¾ã®èª²é¡Œè§£æ±ºã«...',
    content: `ã¯ã˜ã‚ã¾ã—ã¦ã€‚æ ªå¼ä¼šç¤¾â—‹â—‹ã®[ãŠåå‰]ã¨ç”³ã—ã¾ã™ã€‚

çªç„¶ã®ã”é€£çµ¡ã‚’ã”å®¹èµ¦ãã ã•ã„ã€‚
å¼Šç¤¾ã§ã¯â—‹â—‹ã«ç‰¹åŒ–ã—ãŸã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æä¾›ã—ã¦ãŠã‚Šã€è²´ç¤¾ã®ãƒ“ã‚¸ãƒã‚¹èª²é¡Œã®è§£æ±ºã«è²¢çŒ®ã§ãã‚‹ã¨è€ƒãˆã€ã”é€£çµ¡ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚

ãƒ»å°å…¥å®Ÿç¸¾ï¼šâ—‹â—‹ç¤¾ä»¥ä¸Š
ãƒ»ä¸»ãªãƒ¡ãƒªãƒƒãƒˆï¼šã‚³ã‚¹ãƒˆå‰Šæ¸›ã€æ¥­å‹™åŠ¹ç‡åŒ–ã€å£²ä¸Šå‘ä¸Š

ãœã²ä¸€åº¦ã€è©³ç´°ã‚’ã”èª¬æ˜ã™ã‚‹æ©Ÿä¼šã‚’ã„ãŸã ã‘ã‚Œã°å¹¸ã„ã§ã™ã€‚
ã”éƒ½åˆã®ã‚ˆã„æ—¥æ™‚ã«ã¦ãŠæ‰“ã¡åˆã‚ã›ã‚’ãŠé¡˜ã„ã§ãã¾ã™ã§ã—ã‚‡ã†ã‹ã€‚

ã©ã†ãã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚`
  },
  {
    id: 2,
    title: 'ğŸ¤ ã‚¢ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ææ¡ˆ',
    preview: 'è²´ç¤¾ã¨ã®æ¥­å‹™ææºã«ã¤ã„ã¦ã”ç›¸è«‡ã•ã›ã¦ã„ãŸã ããŸã...',
    content: `ã¯ã˜ã‚ã¾ã—ã¦ã€‚[ä¼šç¤¾å]ã®[ãŠåå‰]ã§ã”ã–ã„ã¾ã™ã€‚

ã“ã®åº¦ã¯ã€è²´ç¤¾ã¨ã®æ¥­å‹™ææºã«ã¤ã„ã¦ã”ç›¸è«‡ã•ã›ã¦ã„ãŸã ããŸãã€ã”é€£çµ¡ç”³ã—ä¸Šã’ã¾ã—ãŸã€‚

å¼Šç¤¾ã¯â—‹â—‹åˆ†é‡ã«ãŠã„ã¦â—‹â—‹å¹´ã®å®Ÿç¸¾ã‚’æŒã¡ã€ç¾åœ¨â—‹â—‹ç¤¾æ§˜ã¨ææºé–¢ä¿‚ã«ã”ã–ã„ã¾ã™ã€‚
è²´ç¤¾ã®â—‹â—‹ã¨ã„ã†ãƒ“ã‚¸ãƒã‚¹ã¨å¼Šç¤¾ã®â—‹â—‹ã¨ã„ã†ã‚¢ã‚»ãƒƒãƒˆã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€ãŠäº’ã„ã«ã‚·ãƒŠã‚¸ãƒ¼ãŒç”Ÿã¾ã‚Œã‚‹ã¨ç¢ºä¿¡ã—ã¦ãŠã‚Šã¾ã™ã€‚

ã‚‚ã—ã‚ˆã‚ã—ã‘ã‚Œã°ã€ä¸€åº¦ãŠè©±ã—åˆã„ã®æ©Ÿä¼šã‚’è¨­ã‘ã¦ã„ãŸã ã‘ãªã„ã§ã—ã‚‡ã†ã‹ã€‚
ãŠæ™‚é–“ã¯30åˆ†ã»ã©ã‚’äºˆå®šã—ã¦ãŠã‚Šã¾ã™ã€‚

ã”æ¤œè¨ã®ã»ã©ã€ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚`
  },
  {
    id: 3,
    title: 'ğŸ“‹ è³‡æ–™è«‹æ±‚ãƒ»æƒ…å ±åé›†',
    preview: 'è²´ç¤¾ã®â—‹â—‹ã‚µãƒ¼ãƒ“ã‚¹ã«ã¤ã„ã¦è©³ã—ãçŸ¥ã‚ŠãŸã...',
    content: `ãŠä¸–è©±ã«ãªã‚Šã¾ã™ã€‚[ä¼šç¤¾å]ã®[ãŠåå‰]ã¨ç”³ã—ã¾ã™ã€‚

è²´ç¤¾ã®â—‹â—‹ã‚µãƒ¼ãƒ“ã‚¹ã«ã¤ã„ã¦å¤§å¤‰èˆˆå‘³ã‚’æŒã¡ã€ã”é€£çµ¡ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚

ç¾åœ¨ã€å¼Šç¤¾ã§ã¯â—‹â—‹ã®èª²é¡Œã‚’æŠ±ãˆã¦ãŠã‚Šã€è²´ç¤¾ã®ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ãŒè§£æ±ºç­–ã«ãªã‚Šå¾—ã‚‹ã¨æ„Ÿã˜ã¦ãŠã‚Šã¾ã™ã€‚
ã¤ãã¾ã—ã¦ã¯ã€ä»¥ä¸‹ã®ç‚¹ã«ã¤ã„ã¦è©³ç´°ã‚’ãŠèã‹ã›ã„ãŸã ã‘ã¾ã™ã§ã—ã‚‡ã†ã‹ã€‚

1. å°å…¥è²»ç”¨ãƒ»æ–™é‡‘ãƒ—ãƒ©ãƒ³ã«ã¤ã„ã¦
2. å°å…¥ã¾ã§ã®æœŸé–“ãƒ»ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ã¤ã„ã¦  
3. å¼Šç¤¾ã®ã‚ˆã†ãªâ—‹â—‹æ¥­ç¨®ã§ã®å°å…¥äº‹ä¾‹ã«ã¤ã„ã¦

ãŠæ‰‹æ•°ã§ã™ãŒã€è³‡æ–™ã®ã”é€ä»˜ã¾ãŸã¯ã”èª¬æ˜ã®æ©Ÿä¼šã‚’ã„ãŸã ã‘ã‚Œã°å¹¸ã„ã§ã™ã€‚
ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚`
  },
  {
    id: 4,
    title: 'ğŸ¯ ã‚¤ãƒ™ãƒ³ãƒˆãƒ»ã‚»ãƒŸãƒŠãƒ¼æ‹›å¾…',
    preview: 'å¼Šç¤¾ä¸»å‚¬ã®ã‚»ãƒŸãƒŠãƒ¼ã«ã”æ‹›å¾…ã—ãŸã...',
    content: `ã¯ã˜ã‚ã¾ã—ã¦ã€‚[ä¼šç¤¾å]ã®[ãŠåå‰]ã§ã”ã–ã„ã¾ã™ã€‚

ã“ã®åº¦ã€å¼Šç¤¾ä¸»å‚¬ã«ã¦ä»¥ä¸‹ã®ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚»ãƒŸãƒŠãƒ¼ã‚’é–‹å‚¬ã™ã‚‹é‹ã³ã¨ãªã‚Šã¾ã—ãŸã€‚

ã€ã‚»ãƒŸãƒŠãƒ¼åã€‘â—‹â—‹ã§å®Ÿç¾ã™ã‚‹æ¥­å‹™åŠ¹ç‡åŒ–
ã€æ—¥æ™‚ã€‘20â—‹â—‹å¹´â—‹æœˆâ—‹æ—¥ï¼ˆâ—‹ï¼‰14:00ã€œ15:30
ã€å½¢å¼ã€‘ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ï¼ˆZoomï¼‰
ã€å‚åŠ è²»ã€‘ç„¡æ–™

å†…å®¹ï¼šâ—‹â—‹ã«é–¢ã™ã‚‹æœ€æ–°ãƒˆãƒ¬ãƒ³ãƒ‰ã¨å®Ÿè·µäº‹ä¾‹ã‚’ã”ç´¹ä»‹ã—ã¾ã™ã€‚

è²´ç¤¾ã®ã”æ‹…å½“è€…æ§˜ã«ãœã²ã”å‚åŠ ã„ãŸã ã‘ã‚Œã°ã¨æ€ã„ã€ã”é€£çµ¡å·®ã—ä¸Šã’ã¾ã—ãŸã€‚
ã”å‚åŠ ã”å¸Œæœ›ã®å ´åˆã¯ã€ä»¥ä¸‹ã®URLã‚ˆã‚ŠãŠç”³ã—è¾¼ã¿ãã ã•ã„ã€‚

ã”å‚åŠ ã‚’ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™ã€‚`
  },
  {
    id: 5,
    title: 'ğŸ’¡ èª²é¡Œè§£æ±ºææ¡ˆ',
    preview: 'è²´ç¤¾ãŒæŠ±ãˆã‚‹â—‹â—‹ã®èª²é¡Œã«ã¤ã„ã¦ã€å¼Šç¤¾ã®â—‹â—‹ã§è§£æ±ºã§ãã¾ã™...',
    content: `ã¯ã˜ã‚ã¾ã—ã¦ã€‚[ä¼šç¤¾å]ã®[ãŠåå‰]ã¨ç”³ã—ã¾ã™ã€‚

è²´ç¤¾ãŒâ—‹â—‹ã«ãŠã„ã¦èª²é¡Œã‚’æŠ±ãˆã¦ã„ã‚‰ã£ã—ã‚ƒã‚‹ã¨ä¼ºã„ã€ã”é€£çµ¡ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚

å¼Šç¤¾ã§ã¯â—‹â—‹ã¨ã„ã†ç‹¬è‡ªã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã«ã‚ˆã‚Šã€ä»¥ä¸‹ã®ã‚ˆã†ãªå®Ÿç¸¾ã‚’ä¸Šã’ã¦ãŠã‚Šã¾ã™ã€‚

ãƒ»â—‹â—‹ã®èª²é¡Œã‚’æŒã¤â–³â–³ç¤¾æ§˜ï¼šã‚³ã‚¹ãƒˆ30%å‰Šæ¸›
ãƒ»â—‹â—‹ã§å›°ã£ã¦ã„ãŸâ–¡â–¡ç¤¾æ§˜ï¼šä½œæ¥­æ™‚é–“50%çŸ­ç¸®

åŒæ§˜ã®èª²é¡Œã‚’ãŠæŒã¡ã§ã—ãŸã‚‰ã€å¼Šç¤¾ã®ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ãŒãŠå½¹ã«ç«‹ã¦ã‚‹ã‹ã¨å­˜ã˜ã¾ã™ã€‚

ã¾ãšã¯èª²é¡Œã®ãƒ’ã‚¢ãƒªãƒ³ã‚°ã‚‚å…¼ã­ã¦ã€30åˆ†ã»ã©ã®ãŠæ™‚é–“ã‚’ã„ãŸã ã‘ãªã„ã§ã—ã‚‡ã†ã‹ã€‚
ã”éƒ½åˆã®ã‚ˆã„æ—¥æ™‚ã‚’ãŠçŸ¥ã‚‰ã›ã„ãŸã ã‘ã‚Œã°ã€åˆã‚ã›ã¦å‚ã‚Šã¾ã™ã€‚

ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚`
  }
];

// ========== åˆæœŸåŒ– ==========
function init() {
  renderTemplates();
  addCompany(); // æœ€åˆã®1ç¤¾ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è¿½åŠ 
  checkServerStatus();
  setInterval(checkServerStatus, 10000);
}

async function checkServerStatus() {
  try {
    const res = await fetch(`${API}/api/health`, { signal: AbortSignal.timeout(3000) });
    if (res.ok) {
      document.getElementById('statusDot').className = 'status-dot online';
      document.getElementById('statusText').textContent = 'ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šæ¸ˆã¿';
    }
  } catch {
    document.getElementById('statusDot').className = 'status-dot';
    document.getElementById('statusText').textContent = 'æœªæ¥ç¶š';
  }
}

// ========== ã‚¹ãƒ†ãƒƒãƒ—ç®¡ç† ==========
function goToStep(n) {
  currentStep = n;
  document.querySelectorAll('.section').forEach((s, i) => {
    s.classList.toggle('active', i + 1 === n);
  });
  document.querySelectorAll('.step-btn').forEach((btn, i) => {
    btn.classList.remove('active', 'done');
    if (i + 1 === n) btn.classList.add('active');
    else if (i + 1 < n) btn.classList.add('done');
  });
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function nextStep(currentN) {
  if (currentN === 1) {
    const name = document.getElementById('senderName').value.trim();
    const email = document.getElementById('senderEmail').value.trim();
    const company = document.getElementById('senderCompany').value.trim();
    if (!name || !email || !company) {
      showToast('ãŠåå‰ãƒ»ä¼šç¤¾åãƒ»ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
      return;
    }
  }
  if (currentN === 2) {
    const valid = companies.filter(c => c.url);
    if (valid.length === 0) {
      showToast('ä¼æ¥­URLã‚’å°‘ãªãã¨ã‚‚1ä»¶å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
      return;
    }
  }
  if (currentN === 3) {
    if (!selectedTemplate) {
      showToast('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’1ã¤é¸æŠã—ã¦ãã ã•ã„', 'error');
      return;
    }
    buildSubmitSummary();
  }
  goToStep(currentN + 1);
}

// ========== ä¼æ¥­ç®¡ç† ==========
function addCompany() {
  if (companies.length >= 5) {
    showToast('æœ€å¤§5ç¤¾ã¾ã§è¨­å®šã§ãã¾ã™', 'info');
    return;
  }
  const id = 'c' + Date.now();
  companies.push({ id, name: '', url: '' });
  renderCompanies();
}

function removeCompany(id) {
  companies = companies.filter(c => c.id !== id);
  renderCompanies();
}

function updateCompany(id, field, value) {
  const c = companies.find(c => c.id === id);
  if (c) c[field] = value;
}

function renderCompanies() {
  const list = document.getElementById('companyList');
  list.innerHTML = companies.map((c, i) => `
    <div class="company-card" id="card_${c.id}">
      <div class="company-card-header">
        <div class="company-num">${i + 1}</div>
        <div class="company-name-display">${c.name || `ä¼æ¥­ ${i + 1}`}</div>
        <button class="remove-btn" onclick="removeCompany('${c.id}')">âœ•</button>
      </div>
      <div class="company-fields">
        <div class="form-group">
          <label>ä¼šç¤¾å</label>
          <input type="text" value="${c.name}" placeholder="æ ªå¼ä¼šç¤¾â—‹â—‹"
            oninput="updateCompany('${c.id}','name',this.value);document.querySelector('#card_${c.id} .company-name-display').textContent=this.value||'ä¼æ¥­ ${i+1}'" />
        </div>
        <div class="form-group">
          <label>å•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ URL *</label>
          <input type="url" value="${c.url}" placeholder="https://example.com/contact"
            oninput="updateCompany('${c.id}','url',this.value)" />
        </div>
      </div>
    </div>
  `).join('');

  document.getElementById('addCompanyBtn').style.display =
    companies.length >= 5 ? 'none' : 'flex';
}

// ========== ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ ==========
function renderTemplates() {
  const grid = document.getElementById('templateGrid');
  grid.innerHTML = templates.map(t => `
    <div class="template-card ${selectedTemplate?.id === t.id ? 'selected' : ''}"
         onclick="selectTemplate(${t.id})">
      <div class="template-title">${t.title}</div>
      <div class="template-preview">${t.preview}</div>
    </div>
  `).join('');
}

function selectTemplate(id) {
  selectedTemplate = templates.find(t => t.id === id);
  renderTemplates();

  const editArea = document.getElementById('templateEditArea');
  editArea.style.display = 'block';

  const textarea = document.getElementById('templateEdit');
  textarea.value = selectedTemplate.content;

  textarea.addEventListener('input', () => {
    selectedTemplate.content = textarea.value;
  });
}

// ========== é€ä¿¡æ¦‚è¦ ==========
function buildSubmitSummary() {
  const validCompanies = companies.filter(c => c.url);
  const summaryCard = document.getElementById('submitSummaryCard');
  const summary = document.getElementById('submitSummary');

  const senderName = document.getElementById('senderName').value;
  const senderCompany = document.getElementById('senderCompany').value;

  const content = selectedTemplate.content
    .replace('[ãŠåå‰]', senderName)
    .replace('[ä¼šç¤¾å]', senderCompany);
  selectedTemplate.content = content;
  if (document.getElementById('templateEdit')) {
    document.getElementById('templateEdit').value = content;
  }

  summary.innerHTML = `
    <strong style="color:var(--text)">é€ä¿¡è€…ï¼š</strong>${senderName}ï¼ˆ${senderCompany}ï¼‰<br>
    <strong style="color:var(--text)">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼š</strong>${selectedTemplate.title}<br>
    <strong style="color:var(--text)">é€ä¿¡å…ˆï¼š</strong>${validCompanies.map(c => c.name || c.url).join('ã€')}<br>
    <strong style="color:var(--text)">å¯¾è±¡ç¤¾æ•°ï¼š</strong>${validCompanies.length}ç¤¾
  `;
  summaryCard.style.display = 'block';
}

// ========== ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å–å¾— ==========
async function loadPreview() {
  const validCompanies = companies.filter(c => c.url);
  if (validCompanies.length === 0) {
    showToast('ä¼æ¥­URLã‚’è¨­å®šã—ã¦ãã ã•ã„', 'error');
    return;
  }

  showLoading('ãƒ•ã‚©ãƒ¼ãƒ ã‚’è§£æä¸­...', 'å„ä¼æ¥­ã‚µã‚¤ãƒˆã‚’é–‹ã„ã¦è‡ªå‹•å…¥åŠ›ã—ã¦ã„ã¾ã™ã€‚\næ•°åç§’ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚');
  document.getElementById('previewBtn').disabled = true;

  const payload = {
    companies: validCompanies,
    senderInfo: {
      name: document.getElementById('senderName').value,
      company: document.getElementById('senderCompany').value,
      email: document.getElementById('senderEmail').value,
      phone: document.getElementById('senderPhone').value,
    },
    messageTemplate: selectedTemplate
  };

  try {
    const res = await fetch(`${API}/api/preview`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    previewJobId = data.jobId;

    // ãƒãƒ¼ãƒªãƒ³ã‚°
    pollJob(data.jobId);
  } catch (err) {
    hideLoading();
    showToast('ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
    document.getElementById('previewBtn').disabled = false;
  }
}

async function pollJob(jobId) {
  const res = await fetch(`${API}/api/job/${jobId}`);
  const job = await res.json();

  if (job.status !== 'done' && job.status !== 'error') {
    setTimeout(() => pollJob(jobId), 2000);
    return;
  }

  hideLoading();
  document.getElementById('previewBtn').disabled = false;
  renderPreviews(job);
}

function renderPreviews(job) {
  const area = document.getElementById('previewArea');

  let html = '<div class="preview-list">';

  for (const p of job.previews) {
    const filled = p.fillResults?.filled || [];
    const notFound = p.fillResults?.notFound || [];

    html += `
      <div class="preview-item">
        <div class="preview-item-header">
          <div class="preview-company-name">${p.companyName || p.url}</div>
          <span class="status-badge ready">å…¥åŠ›å®Œäº†</span>
        </div>
        ${p.screenshotUrl ? `<img class="preview-screenshot" src="${API}${p.screenshotUrl}" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" loading="lazy">` : ''}
        <div class="preview-details">
          <div>å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç¢ºèªï¼š</div>
          <div class="fill-result">
            ${filled.map(f => `<span class="fill-tag ok">âœ“ ${f.field}</span>`).join('')}
            ${notFound.map(f => `<span class="fill-tag ng">âœ• ${f}ï¼ˆæœªæ¤œå‡ºï¼‰</span>`).join('')}
          </div>
        </div>
      </div>
    `;
  }

  for (const e of job.errors) {
    html += `
      <div class="preview-item">
        <div class="preview-item-header">
          <div class="preview-company-name">${e.company}</div>
          <span class="status-badge error">ã‚¨ãƒ©ãƒ¼</span>
        </div>
        <div class="preview-details" style="color:var(--danger)">${e.error}</div>
      </div>
    `;
  }

  html += '</div>';
  area.innerHTML = html;
}

// ========== é€ä¿¡å‡¦ç† ==========
function confirmSubmit() {
  const validCompanies = companies.filter(c => c.url);
  document.getElementById('confirmModalBody').innerHTML =
    `ä»¥ä¸‹ã®<strong>${validCompanies.length}ç¤¾</strong>ã®å•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ ã«é€ä¿¡ã—ã¾ã™ã€‚<br><br>` +
    validCompanies.map(c => `ãƒ»${c.name || c.url}`).join('<br>') +
    `<br><br>âš ï¸ ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`;
  document.getElementById('confirmModal').classList.add('active');
}

function closeModal() {
  document.getElementById('confirmModal').classList.remove('active');
}

async function executeSubmit() {
  closeModal();
  showLoading('é€ä¿¡ä¸­...', 'å„ä¼æ¥­ã®ãƒ•ã‚©ãƒ¼ãƒ ã«é€ä¿¡ã—ã¦ã„ã¾ã™ã€‚\nã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚');

  const validCompanies = companies.filter(c => c.url);

  try {
    const res = await fetch(`${API}/api/submit`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        companies: validCompanies,
        senderInfo: {
          name: document.getElementById('senderName').value,
          company: document.getElementById('senderCompany').value,
          email: document.getElementById('senderEmail').value,
          phone: document.getElementById('senderPhone').value,
        },
        messageTemplate: selectedTemplate,
        selectedCompanyIds: validCompanies.map(c => c.id)
      })
    });
    const data = await res.json();
    hideLoading();
    showResults(data.results);
  } catch (err) {
    hideLoading();
    showToast('é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
  }
}

function showResults(results) {
  goToStep(5);
  const list = document.getElementById('resultList');
  list.innerHTML = results.map(r => `
    <div class="preview-item">
      <div class="preview-item-header">
        <div class="preview-company-name">${r.companyName}</div>
        <span class="status-badge ${r.status === 'submitted' ? 'submitted' : 'error'}">
          ${r.status === 'submitted' ? 'é€ä¿¡å®Œäº†' : r.status === 'no_submit_button' ? 'æ‰‹å‹•é€ä¿¡è¦' : 'ã‚¨ãƒ©ãƒ¼'}
        </span>
      </div>
      ${r.screenshotUrl ? `<img class="preview-screenshot" src="${API}${r.screenshotUrl}" alt="çµæœ" loading="lazy">` : ''}
      <div class="preview-details">${r.message || r.error || 'æ­£å¸¸ã«é€ä¿¡ã•ã‚Œã¾ã—ãŸ'}</div>
    </div>
  `).join('');
}

// ========== ãƒªã‚»ãƒƒãƒˆ ==========
function resetAll() {
  companies = [];
  selectedTemplate = null;
  previewJobId = null;
  document.getElementById('senderName').value = '';
  document.getElementById('senderCompany').value = '';
  document.getElementById('senderEmail').value = '';
  document.getElementById('senderPhone').value = '';
  document.getElementById('previewArea').innerHTML = `<p style="color:var(--text-muted);font-size:0.85rem;text-align:center;padding:20px 0">ã€Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å–å¾—ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€å„ä¼æ¥­ã®ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã„ã¦<br>è‡ªå‹•å…¥åŠ›ã—ãŸçŠ¶æ…‹ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ç¢ºèªã§ãã¾ã™ã€‚</p>`;
  document.getElementById('submitSummaryCard').style.display = 'none';
  renderTemplates();
  addCompany();
  goToStep(1);
}

// ========== UI ãƒ˜ãƒ«ãƒ‘ãƒ¼ ==========
function showLoading(title, sub) {
  document.getElementById('loadingTitle').textContent = title;
  document.getElementById('loadingSubText').textContent = sub;
  document.getElementById('loadingOverlay').classList.add('active');
}

function hideLoading() {
  document.getElementById('loadingOverlay').classList.remove('active');
}

function showToast(msg, type = 'info') {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = msg;
  container.appendChild(toast);
  setTimeout(() => toast.remove(), 3500);
}

init();
</script>

</body>
</html>
